<p>Dans cet épisode, nous allons vous montrer pourquoi c'est une mauvaise idée de stocker un modèle dans une session.</p>
<pre class="ruby">
class UserController &lt; ApplicationController
  def prepare
    session[:user] = User.find(:first)
    redirect_to :action =&gt; :'show'
  end

  def show
    @user = session[:user]
  end

  def update
    @user = session[:user]
    @user.name = 'Foo'
    redirect_to :action =&gt; 'show'
  end
end
</pre>
<p class="title">Contrôleur avec des actions qui stockent un modèle en session.</p>
<p>Dans le code précédent, nous avons un contrôleur avec trois actions. La première action, <code>prepare</code>, cherche le premier <code>User</code>, le stocke dans la session, puis redirige vers l'action <code>show</code>. L'action <code>show</code> prend le premier utilisateur à partir de la session et affiche certaines informations de debug concernant l'utilisateur.</p>
<pre class="ruby">
&lt;%= debug(@user) %&gt;
&lt;%= link_to 'update', :action =&gt; 'update' %&gt;
</pre>
<p class="title">Le code de la vue <code>show</code>.</p>
<p>La vue <code>show</code> a un lien vers l'action <code>update</code>. L'action <code>update</code> récupère l'utilisateur courant depuis la session à nouveau, modifie une de ses propriétés puis redirige vers <code>show</code>. La modificaition effectuée dans <code>update</code> devrait être temporaire puisqu'elle n'est pas répercutée en base de données. Finallement, <code>update</code> redirige vers <code>show</code> donc nous pouvons voir les propriétés de l'utilisateur à nouveau.</p>
<img src="/system/photos/9/original/E013I01.png" alt="" width="800" height="570"/>
<p>Nous allons d'abord à <code>/user/prepare</code> qui va commencer par mettre l'utilisateur en session puis rediriger vers <code>show</code>. Dans <code>show</code>, on peut voir que le nom est correct. Ensuite, nous cliquons sur &lsquo;Update&rsquo;, la propriété <code>name</code> est modifiée et nous redirigeons vers <code>show</code> à nouveau. Le nom est maintenant &lsquo;Foo&rsquo;, ce qui est différent du nom de l'utilisateur stocké en base de données. Parce que nous avons stocké l'utilisateur en session, n'importe quel changement effectué est persistent au long de la navigation donc chaque fois que l'on récupère l'utilisateur depuis la session, nous verrons l'<code>User</code> modifié plutôt que celui stocké en base de données. Ce qui peut nous amener à quelques bugs délicats.</p>
<pre class="terminal">
NooNoo:ep13 eifion$ script/console
Loading development environment (Rails 2.2.2)
&gt;&gt; User.first.name
=&gt; "Eifion"
&gt;&gt;
</pre>
<p class="title">L'<code>User</code> dans la base de données à toujours le nom &lsquo;Eifion&rsquo;.</p>

<h3>Problèmes avec les validations</h3>
<p>Notre modèle <code>User</code> a une validation qui contrôle que le nom existe (avec <code>validates_presence_of</code>). Nous allons mettre à jour l'action <code>update</code> pour initialiser le nom avec une chaine vide, contrôler que l'utilisateur est valide et voir ce qui se passe.</p>
<pre class="ruby">
def update
  @user = session[:user]
  @user.name = ''
  @user.valid?
  redirect_to :action =&gt; 'show'
end
</pre>
<p class="title">L'action <code>update</code> mise à jour.</p>
<img src="/system/photos/10/original/E013I02.png" alt="" width="800" height="500"/>
<p>Maintenant nous avons initialisé le nom avec une chaine vide mais il y a toujours des erreurs. Une fois que nous avons redirigé vers une autre page, les erreurs ne devraient pas persister mais parce que nous avons stocké le modèle en session, elles le font même après redirection. Ceci peut amener à confusion un utilisateur qui pourrait voir des erreurs de validation sur une page et les retrouver quand il reviendra sur la page plus tard.</p>

<h3>La bonne façon de faire</h3>
<p>Maintenant, nous allons faire ça proprement. Au lieu de stocker le modèle <code>User</code> en session, nous allons stocker l'<code>id</code> de l'utilisateur. Le contrôleur mis à jour ressemblera à ça :</p>
<pre class="ruby">
class UserController &lt; ApplicationController
  def prepare
    session[:user_id] = User.find(:first).id
    redirect_to :action =&gt; :'show'
  end

  def show
    @user = User.find(session[:user_id])
  end

  def update
    @user = User.find(session[:user_id])
    @user.name = 'Foo'
    redirect_to :action =&gt; 'show'
  end
end
</pre>
<p class="title">Contrôleur avec actions qui enregistre un <code>id</code> en session.</p>
<p>Maintenant, uniquement l'<code>id</code> est stocké en session et l'utilisateur est récupéré depuis la base de données à chaque requête. Cette fois, le changement fait au nom de l'utilisateur ne persiste pas et reste le même à chaque requête.</p>
<img src="/system/photos/11/original/E013I03.png" alt="" width="800" height="400" />
<p>Heureusement, cet épisode a montré les dangers du stockage de modèle et autres objets complexes dans une session Rails. L'objet de session devrait seulement être utilisé pour stocker des objets simples comme des tableaux, des chaines ou des entiers.</p>