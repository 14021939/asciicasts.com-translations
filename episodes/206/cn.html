<p>ActionMailer&#x5728;Rails3.0&#x91CC;&#x9762;&#x6709;&#x5F88;&#x5927;&#x7684;&#x53D8;&#x5316;&#x3002;ActionMailer&#x5728;Rails3.0&#x91CC;&#x9762;&#x4F7F;&#x7528;&#x66F4;&#x597D;&#x7528;&#x7684;<a href="http://lindsaar.net/2010/1/23/mail-gem-version-2-released">Mail</a> gem &#x66FF;&#x4EE3;&#x4E4B;&#x524D;&#x4F7F;&#x7528;&#x7684;TMail gem&#x3002;</p>

<p>&#x6211;&#x4EEC;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;Rails 3 &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6765;&#x6F14;&#x793A;&#x8FD9;&#x4E2A;ActionMailer&#x3002;&#x6211;&#x4EEC;&#x628A;&#x8FD9;&#x4E2A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EB;&#x505A;&#xFF1A;<code>mailit</code>&#x3002;</p>

<pre class="terminal">
rails mailit
</pre>

<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x4E3A;&#x4E00;&#x4E2A;<code>User</code>&#x6A21;&#x578B;&#x521B;&#x5EFA;&#x811A;&#x624B;&#x67B6;(scaffold)&#x3002;&#x8FD9;&#x4E2A;&#x6A21;&#x578B;&#x6709;&#x4E24;&#x4E2A;&#x5C5E;&#x6027;&#xFF1A;<code>name</code>&#x548C;<code>email</code>&#xFF0C;&#x7528;&#x6765;&#x6F14;&#x793A;&#x7B80;&#x5355;&#x7684;&#x7528;&#x6237;&#x6CE8;&#x518C;&#x9875;&#x9762;&#x3002;</p>

<pre class="terminal">
rails g scaffold user name:string email:string
</pre>

<p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x8FD0;&#x884C;&#x6570;&#x636E;&#x5E93;&#x8FC1;&#x79FB;(migrations):</p>

<pre class="terminal">
rake db:migrate
</pre>

<p>&#x521A;&#x624D;&#x751F;&#x6210;&#x7684;&#x811A;&#x624B;&#x67B6;(scaffolding)&#x4EE3;&#x7801;&#x5305;&#x62EC;&#x4E00;&#x4E2A;&#x521B;&#x5EFA;&#x7528;&#x6237;&#x7684;&#x9875;&#x9762;&#x3002;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5728;&#x8FD9;&#x4E2A;&#x8868;&#x5355;(form)&#x63D0;&#x4EA4;&#x540E;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7528;&#x6237;&#x5E76;&#x4E14;&#x53D1;&#x9001;&#x4E00;&#x5C01;&#x786E;&#x8BA4;&#x4FE1;&#x3002;</p>

<div class="imageWrapper">
  <img src="/system/photos/348/original/E206I01.png" width="796" height="315" alt="The user registration form."/>
</div>

<p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x505A;&#x7684;&#x662F;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x521D;&#x59CB;&#x5316;&#x6587;&#x4EF6;(initializer file)&#x5E76;&#x6DFB;&#x52A0;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#x4FE1;&#x606F;,&#x6211;&#x4EEC;&#x628A;&#x5B83;&#x547D;&#x540D;&#x4E3A;<code>setup_mail.rb</code>&#x3002;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x653E;&#x5728;/config/initializers&#x76EE;&#x5F55;&#x4E0B;&#x3002;</p>

<p>&#x5982;&#x679C;&#x4F60;&#x7684;&#x673A;&#x5668;&#x91CC;&#x9762;&#x5DF2;&#x7ECF;&#x5B89;&#x88C5;&#x5E76;&#x914D;&#x7F6E;&#x4E86;sendmail&#xFF0C;ActionMailer&#x4F1A;&#x4F7F;&#x7528;sendmail&#x53D1;&#x9001;&#x90AE;&#x4EF6;&#x3002;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;initializer&#x4E2D;&#x6307;&#x5B9A;SMTP&#x8BBE;&#x7F6E;&#x3002;</p>

<p class="codeFilePath">/config/initializers/setup_mail.rb</p>
<pre class="ruby">
ActionMailer::Base.smtp_settings = {
  :address              =&gt; &quot;smtp.gmail.com&quot;,
  :port                 =&gt; 587,
  :domain               =&gt; &quot;asciicasts.com&quot;,
  :user_name            =&gt; &quot;asciicasts&quot;,
  :password             =&gt; &quot;secret&quot;,
  :authentication       =&gt; &quot;plain&quot;,
  :enable_starttls_auto =&gt; true
}
</pre>

<p>&#x4E5F;&#x8BB8;&#x4F60;&#x60F3;&#x7528;&#x5728;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x4E0B;(production environment)&#x4F7F;&#x7528;&#x53E6;&#x5916;&#x7684;&#x53D1;&#x9001;&#x65B9;&#x5F0F;&#x3002;&#x4F46;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6B63;&#x5728;&#x5F00;&#x53D1;&#x9636;&#x6BB5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x5F0F;&#x5DF2;&#x7ECF;&#x8DB3;&#x591F;&#x4E86;&#x3002;&#x4F60;&#x9700;&#x8981;&#x53BB;&#x6839;&#x636E;&#x4F60;&#x81EA;&#x5DF1;&#x7684;Gmail&#x5E10;&#x53F7;&#x4FE1;&#x606F;&#x53BB;&#x4FEE;&#x6539;<code>domain</code>,<code>user_name</code>,&#x548C;<code>password</code>&#x3002;</p>

<p>&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x4E86;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7528;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x53BB;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x65B0;&#x7684;mailer&#x3002;</p>

<pre class="terminal">
rails g mailer user_mailer
</pre>

<p>&#x8FD9;&#x4E2A;&#x547D;&#x4EE4;&#x4F1A;&#x5E2E;&#x6211;&#x4EEC;&#x5728;<code>/app/mailers</code>&#x76EE;&#x5F55;&#x4E0B;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;<code>user_mailer.rb</code>&#x6587;&#x4EF6;&#x3002;&#x65E9;&#x671F;&#x7248;&#x672C;&#x7684;Rails&#x4F1A;&#x628A;mailer&#x7C7B;&#x6587;&#x4EF6;&#x90FD;&#x653E;&#x5728;<code>/app/models</code>&#x6587;&#x4EF6;&#x5939;&#x91CC;&#x9762;&#xFF0C;&#x5728;Rails 3&#x4ED6;&#x4EEC;&#x88AB;&#x653E;&#x5728;&#x81EA;&#x5DF1;&#x7684;&#x6587;&#x4EF6;&#x5939;&#x91CC;&#x9762;(&#x8BD1;&#x8005;&#x6CE8;&#xFF1A;/app/mailer)&#x3002;Mailers&#x5728;Rails 3&#x50CF;&#x63A7;&#x5236;&#x5668;(controller)&#xFF0C;&#x5E76;&#x4E14;Mailers&#x548C;&#x63A7;&#x5236;&#x5668;&#x5171;&#x4EAB;&#x5F88;&#x591A;&#x5E95;&#x5C42;&#x4EE3;&#x7801;&#x3002;</p>

<p>UserMailer&#x7C7B;&#x7684;&#x9ED8;&#x8BA4;&#x4EE3;&#x7801;&#x770B;&#x8D77;&#x6765;&#x50CF;&#x8FD9;&#x6837;(/app/mailers/user_mailer.rb)&#xFF1A;</p>

<p class="codeFilePath">/app/mailers/user_mailer.rb</p>
<pre class="ruby">
class UserMailer &lt; ActionMailer::Base
  default :from =&gt; &quot;from@example.com&quot;
end
</pre>

<p>&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x628A;<code>default</code>&#x90A3;&#x884C;&#x4EE3;&#x7801;&#x5220;&#x6389;&#xFF0C;&#x5728;&#x540E;&#x9762;&#x6211;&#x4EEC;&#x4F1A;&#x89E3;&#x91CA;&#x8FD9;&#x884C;&#x4EE3;&#x7801;&#x7684;&#x7528;&#x9014;&#x3002;</p>

<p>&#x5C31;&#x50CF;Rails 2&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x91CC;&#x9762;&#x4E00;&#x6837;&#xFF0C;&#x6211;&#x4EEC;&#x4E3A;&#x6BCF;&#x4E2A;&#x6211;&#x4EEC;&#x8981;&#x53D1;&#x9001;&#x7684;email&#x7C7B;&#x578B;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x3002;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;&#x6211;&#x4EEC;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x53EB;&#x505A; <code>registration_confirmation</code>&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>

<p class="codeFilePath">/app/mailers/user_mailer.rb</p>
<pre class="ruby">
class UserMailer &lt; ActionMailer::Base
  def registration_confirmation(user)
    mail(:to =&gt; user.email, :subject =&gt; &quot;Registered&quot;, :from =&gt; &quot;eifion@asciicasts.com&quot;)
  end
end
</pre>

<p>&#x6211;&#x4EEC;&#x7ED9;<code>registration_confirmation</code>&#x65B9;&#x6CD5;&#x4F20;&#x9012;&#x4E00;&#x4E2A;<code>User</code>&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x505A;&#x7684;&#x4EC5;&#x4EC5;&#x662F;&#x8C03;&#x7528;mail&#x65B9;&#x6CD5;&#xFF0C;&#x7ED9;mail&#x65B9;&#x6CD5;&#x4F20;&#x9012;<code>:to</code>,<code>:from</code>&#x548C;<code>:subject</code>&#x4E4B;&#x7C7B;&#x7684;&#x53C2;&#x6570;&#x3002;</p>

<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5728;&#x7C7B;&#x91CC;&#x9762;&#x6709;&#x591A;&#x4E2A;&#x5171;&#x4EAB;&#x76F8;&#x5173;&#x8BBE;&#x7F6E;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x628A;&#x8FD9;&#x4E9B;&#x5171;&#x4EAB;&#x503C;&#x653E;&#x5728;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x5220;&#x9664;&#x7684;default&#x65B9;&#x6CD5;&#x91CC;&#x9762;&#x3002;&#x6BD4;&#x65B9;&#x8BF4;email&#x603B;&#x662F;&#x4ECE;&#x540C;&#x6837;&#x7684;&#x5730;&#x65B9;&#x53D1;&#x9001;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x628A;:from&#x8BBE;&#x7F6E;&#x653E;&#x5230;default&#x91CC;&#x9762;:</p>

<p class="codeFilePath">/app/mailers/user_mailer.rb</p>
<pre class="ruby">
class UserMailer &lt; ActionMailer::Base
  default :from =&gt; &quot;eifion@asciicasts.com&quot;

  def registration_confirmation(user)
    mail(:to =&gt; user.email, :subject =&gt; &quot;Registered&quot;)
  end
end
</pre>

<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x628A;&#x4EFB;&#x4F55;&#x51C6;&#x5907;&#x5171;&#x4EAB;&#x7684;&#x8BBE;&#x5B9A;(&#x4EFB;&#x4F55;&#x53EF;&#x4EE5;&#x5728;<code>mail</code>&#x65B9;&#x6CD5;&#x91CC;&#x9762;&#x8BBE;&#x5B9A;&#x7684;&#x503C;)&#x62BD;&#x51FA;&#x6765;&#x653E;&#x5728;<code>default</code>&#x65B9;&#x6CD5;&#x91CC;&#x9762;&#x3002;</p>

<p>&#x7C7B;&#x4F3C;controllers&#xFF0C;mail&#x9700;&#x8981;&#x6709;&#x76F8;&#x5BF9;&#x4E8E;&#x7684;&#x89C6;&#x56FE;(view)&#x6587;&#x4EF6;&#x3002; &#x6211;&#x4EEC;&#x7684;&#x6CE8;&#x518C;&#x786E;&#x8BA4;&#x90AE;&#x4EF6;&#x7684;&#x89C6;&#x56FE;&#x6587;&#x4EF6;&#x653E;&#x5728;<code>/app/views/user_mailer</code>&#x6587;&#x4EF6;&#x5939;&#x5185;&#x3002; &#x6211;&#x4EEC;&#x51C6;&#x5907;&#x7528;&#x7EAF;&#x6587;&#x672C;&#x7684;&#x5F62;&#x5F0F;&#x53D1;&#x9001;&#x90AE;&#x4EF6;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x7684;&#x6587;&#x4EF6;&#x540D;&#x53EB;&#x505A;<code>registration_confirmation.text.erb</code>&#x3002;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x91CC;&#x9762;&#x7684;&#x4EFB;&#x4F55;&#x5185;&#x5BB9;&#x90FD;&#x5C06;&#x4F5C;&#x4E3A;email&#x7684;&#x5185;&#x5BB9;&#x663E;&#x793A;&#x3002;</p>

<p class="codeFilePath">/app/views/usermailer/registration_confimration.text.erb:</p>
<pre class="erb">
Thank you for registering!
</pre>

<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5199;&#x4E9B;&#x4EE3;&#x7801;&#xFF0C;&#x8FD9;&#x4E9B;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x5F53;&#x521B;&#x5EFA;&#x7528;&#x6237;&#x7684;&#x65F6;&#x5019;&#x53D1;&#x9001;&#x90AE;&#x4EF6;&#x7684;&#x529F;&#x80FD;&#x3002;&#x6709;&#x4E9B;&#x4EBA;&#x559C;&#x6B22;&#x4F7F;&#x7528;<a href="http://api.rubyonrails.org/classes/ActiveRecord/Observer.html">Model Observer</a>&#x53BB;&#x5B9E;&#x73B0;&#xFF0C;&#x4F46;&#x6211;&#x4EEC;&#x51C6;&#x5907;&#x76F4;&#x63A5;&#x5728;controller&#x5C42;&#x91CC;&#x9762;&#x5B9E;&#x73B0;&#x3002; &#x6211;&#x4EEC;&#x8FD9;&#x6837;&#x505A;&#x7684;&#x7406;&#x7531;&#x662F;&#xFF1A; &#x5982;&#x679C;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x89C2;&#x5BDF;&#x8005;(observer), &#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5982;&#x679C;&#x5728;Rails&#x547D;&#x4EE4;&#x884C;(console)&#x91CC;&#x9762;&#x521B;&#x5EFA;User&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x540E;&#x53F0;&#x4E5F;&#x4F1A;&#x53D1;&#x9001;email&#x3002;&#x6211;&#x4EEC;&#x53EA;&#x60F3;&#x7528;&#x6237;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x91CC;&#x9762;&#x521B;&#x5EFA;&#x65F6;&#x53D1;&#x9001;email&#x3002;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x5C31;&#x628A;&#x5B9E;&#x73B0;&#x4EE3;&#x7801;&#x653E;&#x5728;controller&#x91CC;&#x9762;&#x3002;</p>

<p>&#x6211;&#x4EEC;&#x5728;<code>UsersController</code>&#x7684;<code>create</code> action&#x91CC;&#x9762;&#x6DFB;&#x52A0;&#x53D1;&#x9001;email&#x7684;&#x4EE3;&#x7801;&#x3002;&#x6211;&#x4EEC;&#x6240;&#x9700;&#x8981;&#x505A;&#x7684;&#x4EC5;&#x4EC5;&#x662F;&#x8C03;&#x7528;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x5199;&#x7684;<code>registration_confirmation</code>&#x65B9;&#x6CD5;&#xFF0C;&#x628A;&#x65B0;&#x521B;&#x5EFA;&#x7684;user&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x8FDB;&#x53BB;&#xFF0C;&#x6700;&#x540E;&#x8C03;&#x7528;<code>deliver</code>&#x65B9;&#x6CD5;&#x53D1;&#x9001;email&#x3002;</p>

<p class="codeFilePath">/app/controllers/users_controller.rb</p>
<pre class="ruby">
def create
  @user = User.new(params[:user])

  respond_to do |format|
    if @user.save
      UserMailer.registration_confirmation(@user).deliver
      format.html { redirect_to(@user, :notice =&gt; &#x27;User was successfully created.&#x27;) }
      format.xml  { render :xml =&gt; @user, :status =&gt; :created, :location =&gt; @user }
    else
      format.html { render :action =&gt; &quot;new&quot; }
      format.xml  { render :xml =&gt; @user.errors, :status =&gt; :unprocessable_entity }
    end
  end
end
</pre>

<p>&#x8FD9;&#x4E2A;&#x8DDF;Rails 2&#x6709;&#x70B9;&#x4E0D;&#x540C;&#xFF0C;&#x5728;Rails 2&#x91CC;&#xFF0C;&#x6211;&#x4EEC;&#x8C03;&#x7528;<code>deliver_registration_confirmation</code>&#x65B9;&#x6CD5;&#x3002; &#x73B0;&#x5728;&#x6211;&#x4EEC;&#x7684;registration_confirmation&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;mail message&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x8C03;&#x7528;&#x5B83;&#x7684;deliver&#x65B9;&#x6CD5;&#x3002; &#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x53D1;&#x9001;email&#x7684;&#x65F6;&#x5019;&#x624D;&#x8C03;&#x7528;deliver&#x3002;</p>

<p>&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x6D4B;&#x8BD5;&#x4E00;&#x4E0B;&#xFF1A; &#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7528;&#x6237;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x63D0;&#x4EA4;&#x8868;&#x5355;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7CFB;&#x7EDF;&#x5C31;&#x4F1A;&#x53D1;&#x9001;&#x4E00;&#x5C01;email.</p>

<div class="imageWrapper">
  <img src="/system/photos/349/original/E206I02.png" width="798" height="340" alt="The registration email send from the application."/>
</div>

<p>&#x4ECE;&#x4E0A;&#x56FE;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6211;&#x4EEC;&#x90AE;&#x4EF6;&#x53D1;&#x9001;&#x6210;&#x529F;&#x3002;</p>

<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x60F3;&#x5728;email&#x91CC;&#x9762;&#x663E;&#x793A;&#x521A;&#x6CE8;&#x518C;&#x7684;&#x7528;&#x6237;&#x7684;&#x59D3;&#x540D;&#x8BE5;&#x600E;&#x4E48;&#x529E;&#x5462;&#xFF1F; &#x6211;&#x4EEC;&#x9700;&#x8981;&#x628A;user&#x5BF9;&#x8C61;&#x4F20;&#x5230;view&#x91CC;&#x9762;&#x3002; &#x5728;Rails 3&#x91CC;&#x9762;&#x6211;&#x4EEC;&#x5F88;&#x5BB9;&#x6613;&#x5C31;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x505A;&#xFF0C;&#x56E0;&#x4E3A;mailers&#x5C31;&#x50CF;controllers&#x4E00;&#x6837;&#xFF0C; &#x4EFB;&#x4F55;&#x5B9E;&#x4F8B;&#x53D8;&#x91CF;(instance variables)&#x90FD;&#x53EF;&#x4EE5;&#x5728;view&#x91CC;&#x9762;&#x8BBF;&#x95EE;&#x3002; &#x6211;&#x4EEC;&#x9700;&#x8981;&#x505A;&#x7684;&#x4EC5;&#x4EC5;&#x662F;&#x7528;&#x4F20;&#x9012;&#x5230;<code>registration_confirmation</code>&#x65B9;&#x6CD5;&#x7684;user&#x53D8;&#x91CF;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;view&#x91CC;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x7684;&#x5B9E;&#x4F53;&#x53D8;&#x91CF;&#x3002;</p>

<p class="codeFilePath">/app/mailers/user_mailer.rb</p>
<pre class="ruby">
def registration_confirmation(user)
  @user = user
  mail(:to =&gt; user.email, :subject =&gt; &quot;Registered&quot;)
end
</pre>

<p>&#x56E0;&#x4E3A;<code>mail</code>&#x65B9;&#x6CD5;&#x4F1A;&#x8FD4;&#x56DE;mail message&#xFF0C;mail&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x5FC5;&#x987B;&#x5199;&#x5728;&#x65B9;&#x6CD5;&#x7684;&#x6700;&#x540E;&#x3002; &#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5F97;&#x5728;mail&#x65B9;&#x6CD5;&#x524D;&#x5B9A;&#x4E49;&#x5B9E;&#x4F53;&#x53D8;&#x91CF;&#x3002;</p>

<p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5728;mailer&#x91CC;&#x9762;&#x5B9A;&#x4E49;&#x4E86;&#x5B9E;&#x4F53;&#x53D8;&#x91CF;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;view&#x91CC;&#x9762;&#x4F7F;&#x7528;&#x5B83;&#x628A;&#x7528;&#x6237;&#x7684;&#x59D3;&#x540D;&#x6DFB;&#x52A0;&#x5728;email&#x91CC;&#x3002;</p>

<p class="codeFilePath">/app/views/user_mailer/registration_confirmation.text.erb</p>
<pre class="erb">
&lt;%= @user.name %&gt;,

Thank you for registering!
</pre>

<p>&#x5F53;&#x6211;&#x4EEC;&#x518D;&#x6B21;&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7528;&#x6237;&#xFF0C;&#x7528;&#x6237;&#x7684;&#x59D3;&#x540D;&#x5C06;&#x4F1A;&#x663E;&#x793A;&#x5728;email&#x7684;&#x5185;&#x5BB9;&#x91CC;:</p>

<div class="imageWrapper">
  <img src="/system/photos/350/original/E206I03.png" width="797" height="340" alt="The new user&rsquo;s name is now included in the email."/>
</div>

<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x5728;email&#x91CC;&#x9762;&#x63D0;&#x4F9B;&#x7ED9;&#x65B0;&#x7528;&#x6237;&#x7F16;&#x8F91;&#x4ED6;&#x4EEC;&#x7684;&#x4E2A;&#x4EBA;&#x4FE1;&#x606F;&#x7684;&#x94FE;&#x63A5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x505A;:</p>

<pre class="erb">
Edit Profile: &lt;%= edit_user_url(@user) %&gt;
</pre>

<p>&#x8FD9;&#x6837;&#x662F;&#x65E0;&#x6CD5;&#x5DE5;&#x4F5C;&#x7684;&#x3002; &#x6211;&#x4EEC;&#x5FC5;&#x987B;&#x4F7F;&#x7528;<code>:host</code>&#x63D0;&#x4F9B;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x57DF;&#x540D;.</p>

<p class="codeFilePath">/app/views/user_mailer/registration_confirmation.text.erb</p>
<pre class="erb">
&lt;%= @user.name %&gt;,

Thank you for registering!

Edit Profile: &lt;%= edit_user_url(@user, :host =&gt; &quot;localhost:3000&quot;) %&gt;
</pre>

<p>&#x5FC5;&#x987B;&#x8FD9;&#x6837;&#x505A;&#x7684;&#x539F;&#x56E0;&#x662F;mailers&#x5DF2;&#x7ECF;&#x5B8C;&#x5168;&#x4ECE;&#x5F53;&#x524D;&#x7684;&#x8BF7;&#x6C42;(request)&#x5206;&#x79BB;&#x51FA;&#x6765;&#x3002; &#x8FD9;&#x6837;&#x8BBE;&#x8BA1;&#x7684;&#x539F;&#x56E0;&#x662F;&#xFF1A;mailer&#x53EF;&#x4EE5;&#x4E0D;&#x5728;&#x5F53;&#x524D;controller&#x7684;&#x8BF7;&#x6C42;&#x5185;&#x53D1;&#x9001;email&#x3002;</p>

<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x4E4B;&#x524D;&#x7684;initializer&#x6587;&#x4EF6;&#x91CC;&#x8BBE;&#x5B9A;host&#x7684;&#x503C;&#xFF0C;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x5BF9;&#x6BCF;&#x5C01;email&#x7684;&#x6BCF;&#x4E2A;link&#x90FD;&#x8BBE;&#x5B9A;host&#x503C;&#x3002;</p>

<p class="codeFilePath">/config/initializers/setup_mail.rb</p>
<pre class="ruby">
ActionMailer::Base.smtp_settings = {
  :address              =&gt; &quot;smtp.gmail.com&quot;,
  :port                 =&gt; 587,
  :domain               =&gt; &quot;asciicasts.com&quot;,
  :user_name            =&gt; &quot;asciicasts&quot;,
  :password             =&gt; &quot;secret&quot;,
  :authentication       =&gt; &quot;plain&quot;,
  :enable_starttls_auto =&gt; true
}

ActionMailer::Base.default_url_options[:host] = &quot;localhost:3000&quot;
</pre>

<p>&#x6211;&#x4EEC;&#x5728;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x7528;hash&#x6307;&#x5B9A;&#x4EFB;&#x4F55;&#x8BBE;&#x7F6E;(options)&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x8BBE;&#x5B9A;host&#x503C;&#x3002;&#x5F53;&#x6211;&#x4EEC;&#x518D;&#x6B21;&#x6CE8;&#x518C;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;email&#x91CC;&#x9762;&#x770B;&#x5230;&#x4E00;&#x4E2A;&#x5E26;&#x6709;&#x6B63;&#x786E;url&#x7684;&#x94FE;&#x63A5;&#x3002;</p>

<div class="imageWrapper">
  <img src="/system/photos/351/original/E206I04.png" width="797" height="340" alt="The registration email now has a link to the user's profile."/>
</div>

<h3>Multipart&#x90AE;&#x4EF6;&#x4E0E;&#x9644;&#x4EF6;</h3>

<p>&#x5728;Rails 3&#x91CC;&#x9762;&#x53D1;&#x9001;multipart emails&#x4E5F;&#x76F8;&#x5F53;&#x65B9;&#x4FBF;&#x3002; &#x6211;&#x4EEC;&#x6240;&#x9700;&#x8981;&#x505A;&#x7684;&#x4EC5;&#x4EC5;&#x662F;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8DDF;text view&#x540C;&#x540D;&#x7684;&#x89C6;&#x56FE;&#x6587;&#x4EF6;(view)&#x3002; &#x5728;&#x6211;&#x4EEC;&#x7684;&#x4F8B;&#x5B50;&#x91CC;&#x9762;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x4E3A;<code>registration_confirmation.html.erb</code>&#x3002; &#x5728;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x91CC;&#x9762;&#xFF0C;&#x6211;&#x4EEC;&#x6DFB;&#x52A0;&#x4E00;&#x4E9B;&#x7B80;&#x5355;&#x7684;html&#x4EE3;&#x7801;&#x3002;</p>

<p class="codeFilePath">/app/views/user_mailer/registration_confirmation.html.erb</p>
<pre class="erb">
&lt;p&gt;&lt;%= @user.name %&gt;,&lt;/p&gt;

&lt;p&gt;Thank you for registering!&lt;/p&gt;

&lt;p&gt;&lt;%= link_to &quot;Edit Profile&quot;, edit_user_url(@user, :host =&gt; &quot;localhost:3000&quot;) %&gt;&lt;/p&gt;
</pre>

<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5728;&#x652F;&#x6301;html&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x67E5;&#x770B;email&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x4F1A;&#x770B;&#x5230;email&#x91CC;&#x9762;&#x6709;&#x4E00;&#x4E2A;&#x94FE;&#x63A5;&#x3002;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#x7684;email&#x5185;&#x5BB9;&#x90FD;&#x4F1A;&#x53D1;&#x9001;&#xFF0C;&#x8FD9;&#x6837;&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x4E0D;&#x652F;&#x6301;html&#xFF0C;&#x5B83;&#x5C06;&#x4F1A;&#x663E;&#x793A;&#x7EAF;&#x6587;&#x672C;&#x5F62;&#x5F0F;&#x7684;email&#x5185;&#x5BB9;&#x3002;</p>

<div class="imageWrapper">
  <img src="/system/photos/352/original/E206I05.png" width="797" height="340" alt="The email is displayed as HTML."/>
</div>

<p>&#x6DFB;&#x52A0;&#x9644;&#x4EF6;&#x64CD;&#x4F5C;&#x76F8;&#x5F53;&#x76F4;&#x63A5;&#x800C;&#x7B80;&#x5355;&#x3002;&#x6211;&#x4EEC;&#x53EA;&#x7528;&#x8C03;&#x7528;attachements&#x65B9;&#x6CD5;&#xFF0C;&#x8BBE;&#x7F6E;&#x9644;&#x4EF6;&#x540D;&#x79F0;&#xFF0C;&#x5E76;&#x8BFB;&#x53D6;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x7ED9;&#x8FD9;&#x4E2A;&#x9644;&#x4EF6;&#x3002;</p>

<p class="codeFilePath">/app/mailers/user_mailer.rb</p>
<pre class="ruby">
def registration_confirmation(user)
  @user = user
  attachments[&quot;rails.png&quot;] = File.read(&quot;#{Rails.root}/public/images/rails.png&quot;)
  mail(:to =&gt; &quot;#{user.name} &lt;#{user.email}&gt;&quot;, :subject =&gt; &quot;Registered&quot;)
end
</pre>

<p>&#x5F53;&#x6211;&#x4EEC;&#x518D;&#x6B21;&#x6CE8;&#x518C;&#xFF0C;<code>rails.png</code>&#x6587;&#x4EF6;&#x5C31;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x9644;&#x4EF6;&#x663E;&#x793A;&#x5728;email&#x91CC;&#x9762;&#x3002; &#x6CE8;&#x610F;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x6211;&#x4EEC;&#x628A;&#x7528;&#x6237;&#x7684;&#x59D3;&#x540D;&#x6DFB;&#x52A0;&#x5230;<code>:to</code>&#x91CC;&#x9762;&#x4E86;&#x3002;</p>

<div class="imageWrapper">
  <img src="/system/photos/353/original/E206I06.png" width="765" height="340" alt="Adding an attachment."/>
</div>

<p>&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x4F7F;&#x7528;&#x65B0;&#x7684;ActionMailer API,&#x6211;&#x4EEC;&#x5F88;&#x5BB9;&#x6613;&#x5C31;&#x521B;&#x5EFA;&#x590D;&#x6742;&#x7684;emails. &#x9ED8;&#x8BA4;&#x7684;&#x8BBE;&#x7F6E;&#x57FA;&#x672C;&#x4E0A;&#x591F;&#x7528;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x60F3;&#x8BBE;&#x7F6E;&#x7C7B;&#x4F3C;&#x7F16;&#x7801;&#x683C;&#x5F0F;(encoding types)&#x7684;&#x503C;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;&#x8986;&#x76D6;&#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;&#x3002;</p>

<h3>&#x62E6;&#x622A;&#x5668;(Interceptors)</h3>

<p>&#x518D;&#x7ED3;&#x675F;&#x672C;&#x7AE0;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x5C06;&#x4F1A;&#x4ECB;&#x7ECD;&#x4E00;&#x5411;&#x65B0;&#x6280;&#x672F;&#xFF1A;&#x5728;email messages&#x53D1;&#x9001;&#x524D;&#x62E6;&#x622A;&#x5B83;&#x4EEC;&#x3002; &#x62E6;&#x622A;&#x5668;&#x53EF;&#x4EE5;&#x5E2E;&#x6211;&#x4EEC;&#x5728;&#x5F00;&#x53D1;&#x6A21;&#x5F0F;&#x7684;&#x65F6;&#x5019;(development mode)&#x6539;&#x53D8;email&#x7684;&#x53D1;&#x9001;&#x65B9;&#x5F0F;&#xFF0C; &#x8FD9;&#x6837;emails&#x5C06;&#x4F1A;&#x53EA;&#x53D1;&#x9001;&#x5230;&#x4F60;&#x81EA;&#x5DF1;&#x7684;&#x5E10;&#x53F7;&#x91CC;&#x800C;&#x4E0D;&#x4F1A;&#x53D1;&#x9001;&#x5230;&#x4EFB;&#x4F55;&#x4F60;&#x521B;&#x5EFA;&#x7684;&#x7528;&#x6237;&#x7684;email&#x5E10;&#x53F7;&#x91CC;&#x3002;</p>

<p>&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#x521A;&#x521A;&#x88AB;&#x52A0;&#x5728;&#x65B0;&#x7684;Mail gem&#x91CC;&#xFF0C; &#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5347;&#x7EA7;mail&#x5230;&#x6700;&#x65B0;&#x7248;&#x672C;(&#x81F3;&#x5C11;2.1.3)&#x3002;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x4FEE;&#x6539;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;Gemfile&#x6587;&#x4EF6;&#x53BB;&#x83B7;&#x5F97;&#x6B63;&#x786E;&#x7684;&#x7248;&#x672C;:</p>

<p class="codeFilePath">/Gemfile</p>
<pre class="ruby">
gem &quot;mail&quot;, &quot;2.1.3&quot;
</pre>

<p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x8FD0;&#x884C;<code>bundle install</code>&#x53BB;&#x5B89;&#x88C5;&#x5347;&#x7EA7;&#x7684;&#x7248;&#x672C;&#x3002;</p>

<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x521B;&#x5EFA;&#x62E6;&#x622A;&#x5668;(interceptor)&#x7C7B;&#x3002; &#x6211;&#x4EEC;&#x628A;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#x547D;&#x540D;&#x4E3A;<code>development_mail_interceptor.rb</code>&#x5E76;&#x628A;&#x5B83;&#x653E;&#x5728;<code>/lib</code>&#x76EE;&#x5F55;&#x4E0B;&#x3002;</p>

<p class="codeFilePath">/lib/development_mail_interceptor.rb</p>
<pre class="ruby">
class DevelopmentMailInterceptor
  def self.delivering_email(message)
    message.subject = &quot;[#{message.to}] #{message.subject}&quot;
    message.to = &quot;eifion@asciicasts.com&quot;
  end
end
</pre>

<p>&#x7C7B;&#x65B9;&#x6CD5;<code>delivering_email</code>&#x83B7;&#x5F97;&#x51C6;&#x5907;&#x53D1;&#x9001;&#x7684;email message&#xFF0C; &#x4FEE;&#x6539;&#x5B83;&#x7684;&#x4E3B;&#x9898;(subject)&#x4E3A;&#x539F;&#x76EE;&#x6807;&#x5730;&#x5740;(message.to) &#x52A0;&#x4E0A;&#x539F;&#x4E3B;&#x9898;(message.subject)&#x3002;message&#x7684;to&#x5B57;&#x6BB5;&#x4E5F;&#x88AB;&#x4FEE;&#x6539;&#xFF0C;&#x8FD9;&#x6837;&#x6240;&#x6709;&#x7684;email&#x5C06;&#x4F1A;&#x53D1;&#x5230;<code>eifion@asciicasts.com</code>&#x3002;</p>

<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x628A;&#x8FD9;&#x4E2A;&#x62E6;&#x622A;&#x5668;(interceptor)&#x6CE8;&#x518C;&#x5230;&#x6211;&#x4EEC;&#x7684;&#x521D;&#x59CB;&#x5316;&#x6587;&#x4EF6;(initializer)&#x5185;:</p>

<p class="codeFilePath">/config/initializers/setup_mail.rb</p>
<pre class="ruby">
Mail.register_interceptor(DevelopmentMailInterceptor) if Rails.env.development?
</pre>

<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x5728;&#x5F00;&#x53D1;&#x6A21;&#x5F0F;(development mode)&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x62E6;&#x622A;&#x5668;(interceptor)&#x7684;<code>delivering_email</code>&#x65B9;&#x6CD5;&#x5C06;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#x3002; &#x5982;&#x679C;&#x6211;&#x4EEC;&#x7684;Rails 3.0 &#x5305;&#x542B;&#x5347;&#x7EA7;&#x4E86;&#x7684;Mail gem, &#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x628A;&#x65B9;&#x6CD5;&#x8C03;&#x7528;<code>Mail.register_interceptor</code>&#x66FF;&#x6362;&#x4E3A;<code>ActionMailer::Base.register_interceptor</code></p>

<p>&#x5F53;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x65B0;&#x7528;&#x6237;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6CE8;&#x518C;&#x786E;&#x8BA4;email&#x5C06;&#x6C38;&#x8FDC;&#x53D1;&#x7ED9;<code>eifion@asciicasts.com</code>&#x3002; &#x539F;&#x59CB;&#x7684;&#x6536;&#x4EF6;&#x4EBA;(recipient)&#x5730;&#x5740;&#x663E;&#x793A;&#x5728;&#x4E3B;&#x9898;&#x680F;&#x3002;</p>

<div class="imageWrapper">
  <img src="/system/photos/354/original/E206I07.png" width="765" height="340" alt="In development mode the email is now sent to us rather than the intended user."/>
</div>

<p>&#x5F53;&#x4F60;&#x5F00;&#x53D1;&#x4F60;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x662F;&#x4E2A;&#x68C0;&#x67E5;&#x4F60;&#x7684;emails&#x662F;&#x5426;&#x5DE5;&#x4F5C;&#x7684;&#x597D;&#x529E;&#x6CD5;&#x3002;</p>

<p>&#x4EE5;&#x4E0A;&#x5C31;&#x662F;&#x8FD9;&#x7AE0;&#x7684;&#x5168;&#x90E8;&#x4E86;&#x3002; &#x6211;&#x5E0C;&#x671B;&#x8FD9;&#x7AE0;&#x5BF9;&#x4F60;&#x6709;&#x7528;&#x3002;&#x65B0;&#x7684;ActionMailer API &#x8BA9; Rails &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53D1;&#x9001;email&#x66F4;&#x52A0;&#x65B9;&#x4FBF;&#x3002;</p>