<p><img src="/system/photos/13/original/E017I01.png" width="392" height="402" alt="The edit form with the checkboxes added." style="float: right;"/>In our example application for this episode we have two models, <code>Product</code> and <code>Category</code>, each with a <code>has_and_belongs_to_many</code> relationship with the other. What we would like to be able to do is to edit the categories that a product is in by using a list of checkboxes on the edit form for that product.</p>

<h3>Adding the checkboxes</h3>
<p>The form for editing our product currently has fields for the product&rsquo;s name and price, but no way of editing the categories the product is in. There are two methods for adding a checkbox to a form, <code>check_box</code> and <code>check_box_tag</code>. We&rsquo;re going to use <code>check_box_tag</code> as is gives us the control we need over the name of the checkbox. The code we&rsquo;ll add to the edit form (<code>products/edit.html.erb</code>) is shown below.</p>

<pre class="ruby" style="clear: both;">
&lt;% for category in Category.find(:all) %&gt;
    &lt;div&gt;
      &lt;%= check_box_tag &quot;product[category_ids][]&quot;, category.id, @product.categories.include?(category) %&gt;
      &lt;%= category.name %&gt;
    &lt;/div&gt;
&lt;% end %&gt;
</pre>

<p><code>check_box_tag</code> takes three parameters: the name of the checkbox, the value of the checkbox and a boolean value that determines whether the checkbox should be checked. The name we&rsquo;ve used looks a little strange, but you&rsquo;ll see why it is named this way shortly. We determine if each category checkbox should be checked or not by seeing if the product is in that category by using <code>@product.categories.include?(category)</code>.

<h3>Seeing if it works</h3>
<img src="/system/photos/14/original/E017I02.png" width="800" height="500" alt="The edit form with the checkboxes added."/>
<p class="title">The edit form with the checkboxes added.</p>
<p>If we refresh the form and test it, we see that it works and the product&rsquo;s categories are updated when we check some of the checkboxes and click &lsquo;submit&rsquo;. How does Rails know how to update the product correctly? The development log has the answer.</p>

<pre class="terminal">
Processing ProductsController#update (for 127.0.0.1 at 2009-01-15 20:57:56) [PUT]
Parameters: {&quot;commit&quot;=&gt;&quot;Edit&quot;, &quot;authenticity_token&quot;=&gt;&quot;31b711f2c24ae7cea5abf3f758eef46b472eebf3&quot;, &quot;product&quot;=&gt;{&quot;price&quot;=&gt;&quot;99.0&quot;, &quot;name&quot;=&gt;&quot;Television Stand&quot;, &quot;category_ids&quot;=&gt;[&quot;2&quot;, &quot;4&quot;]}, &quot;id&quot;=&gt;&quot;1&quot;}
</pre>
<p>When it&rsquo;s submitted, the edit form passes the category parameters in the product hash as an array. It does this because of the name we gave the checkboxes, <code>product[category_ids][]</code>. The first part of the name tells Rails to pass the category_ids as part of the product hash, while the empty square brackets tell it to pass the values as an array. But where does the product&rsquo;s <code>category_ids</code> method, which is called when the parameters for the product are updated, come from? The answer is that its generated by the <code>has_and_belongs_to_many</code> method in the <code>Product</code> model. We can test this by opening <code>script/console</code> and updating a product manually.</p>

<pre class="terminal">
&gt;&gt; p = Product.first
=&gt; #&lt;Product id: 1, name: &quot;Television Stand&quot;, price: 99.0, created_at: &quot;2009-01-11 21:32:12&quot;, updated_at: &quot;2009-01-11 21:32:12&quot;&gt;
&gt;&gt; p.category_ids
=&gt; [2, 3]
&gt;&gt; p.category_ids = [1,4]
=&gt; [1, 4]
&gt;&gt; 
</pre>

<p>When we do this Rails generates the following SQL to update the product&rsquo;s categories:</p>
<pre class="sql">
DELETE FROM &quot;categories_products&quot; WHERE product_id = 1 AND category_id IN (2,3)
INSERT INTO &quot;categories_products&quot; (&quot;product_id&quot;, &quot;id&quot;, &quot;category_id&quot;) VALUES (1, 1, 1)
INSERT INTO &quot;categories_products&quot; (&quot;product_id&quot;, &quot;id&quot;, &quot;category_id&quot;) VALUES (1, 4, 4)
</pre>

<h3>One Small Gotcha</h3>
<p>There is still one small problem with our update method. If we uncheck all of the checkboxes to remove a product from all categories then the update fails to remove any categories the product was in. This is because a checkbox on an HTML form will not have its value sent back if it is unchecked and therefore <code>no category_ids</code> will appear in the product&rsquo;s parameters hash, meaning that the <code>category_ids</code> are not updated.</p>

<p>To fix this we have to modify our products controller to set the <code>category_ids</code> parameter to be an empty array if it is not passed to the update action. We can do this using Ruby&rsquo;s <code>||=</code> operator and add the following like at the top of the update action.</p>
<code class="ruby">
params[:product][:category_ids] ||= []
</code>
<p>This will ensure that if none of the checkboxes are checked then the product is updated correctly so that it is in no categories.</p>