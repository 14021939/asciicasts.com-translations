<p>O primeiro release candidate do Rails 3.0 já foi lançado. Esse é um ótimo momento para experimentar o Rails 3, se você já não tiver feito isso, e para ver quais mudanças precisam ser feitas em suas aplicações Rails 2 para atualizá-las. Neste episódio vamos mostrar como atualizar uma aplicação Rails 2.3 para Rails 3.0.</p>

<p>Já existe uma série de episódios sobre Rails 3.0 que você pode assistir ou ler e nós vamos fazer referências a alguns episódios relevantes enquanto trabalhamos com a atualização. A aplicação que vamos começar a atualizar é o site railscasts.com. O código fonte está disponível no <a href="http://github.com/ryanb/railscasts">Github</a>.</p>

<p>Mesmo se você não estiver pronto para usar Rails 3 em produção, ainda vale a pena tentar atualizar as aplicações Rails 2 só para ver quais problemas você terá que enfrentar. Se suas aplicações usam Git para controle de versão, é fácil criar um branch separado para experimentar. Vamos criar um novo branch chamado <code>rails3</code>.</p>

<pre class="terminal">
$ git checkout -b rails3
Switched to a new branch &#x27;rails3&#x27;
</pre>

<h3>Antes de começarmos a atualização</h3>

<p>Antes de atualizar uma aplicação para o Rails 3, devemos atualizá-la para a última versão do Rails 2.3, que no momento é o Rails 2.3.8. Da mesma forma, qualquer gem que a aplicação usa, deve ser atualizada para a versão mais recente. Desta forma, vamos garantir que não existem problemas de compatibilidade com as versões mais recentes.</p>

<p>Uma vez que tenhamos atualizado o Rails e as gems, devemos executar nossos testes. Ter uma boa suíte de testes automatizados ajudará a garantir que tudo ainda está funcionando como deveria.</p>

<pre class="terminal">
$ rake spec
(in /Users/eifion/rails/apps_for_asciicasts/ep225/railscasts)
DEPRECATION WARNING: Rake tasks in vendor/plugins/hoptoad_notifier/tasks 
........................................................................................................................................................

152 examples, 0 failures
</pre>

<p>Todos os testes passaram. Então estamos prontos para a atualização.</p>

<h3>Atualizando o Ruby e Instalando o Rails 3</h3>

<p>Para a atualização, queremos utilizar a última versão do Ruby em um ambiente limpo para a aplicação Rails 3, por isso vamos usar o <a href="http://rvm.beginrescueend.com">rvm</a> para instalar a última versão do Ruby 1.9.2 e instalar o Rails 3.0. O rvm é atualizado frequentemente, por isso vamos garantir que temos a versão mais recente executando <code>update rvm</code> antes de instalar o Ruby.</p>

<pre class="terminal">
$ rvm update

rvm 0.1.40 by Wayne E. Seguin (wayneeseguin@gmail.com) [http://rvm.beginrescueend.com/]

info: fetching rvm-0.1.43.tar.gz

info: Extracting rvm-0.1.43.tar.gz ...

info: Installing rvm-0.1.43...
</pre>

<p>Uma vez que o rvm está atualizado, precisamos recarregá-lo. Podemos fazer isso, executando:</p>

<pre class="terminal">
$ rvm reload
</pre>

<p>Agora podemos usar o rvm para instalar o Ruby 1.9.2.</p>

<pre class="terminal">
$ rvm install 1.9.2
</pre>

<p>Esse comando irá baixar, compilar e instalar a última versão do Ruby 1.9.2, atualmente em rc2. Quando estiver concluído (pode demorar alguns minutos) poderemos mudar para a nova versão e verificar se ela funciona.</p>

<pre class="terminal">
$ rvm 1.9.2
$ ruby -v
ruby 1.9.2dev (2010-07-11 revision 28618) [x86_64-darwin10.4.0]
</pre>

<p>Agora que sabemos que estamos rodando a versão correta do Ruby, podemos instalar a gem do Rails 3.0 release candidate.</p>

<pre class="terminal">
gem install rails --pre
</pre>

<p>Note que como estamos usando uma versão do Ruby instalada com rvm, não precisamos usar sudo para instalar gems.</p>

<h3>Começando a atualização</h3>

<p>Agora temos uma nova instalação do Ruby e o Rails 3.0. Então estamos prontos para começar a atualizar nossa aplicação. Para nos ajudar, temos o <a href="http://github.com/rails/rails_upgrade">rails_upgrade plugin</a>, que é um plugin oficial que podemos usar para ver quais alterações precisamos fazer. Para instalar o rails_upgrade, primeiro precisamos voltar para o Rails 2, que está instalado no ambiente do Ruby do sistema.</p>

<pre class="terminal">
$ rvm system
</pre>

<p>Agora podemos instalar o plugin.</p>

<pre class="terminal">
$ script/plugin install git://github.com/rails/rails_upgrade.git
</pre>

<p>Será apresentada uma <a href="http://github.com/rails/rails_upgrade/blob/master/install.rb">documentação útil</a> depois da instalação. Um dos principais comandos que ele acrescenta é o <code>rake rails:upgrade:check</code>. Quando executamos esse comando no diretório da nossa aplicação, ele irá mostrar uma lista de tudo que precisa ser atualizado em nossa aplicação. A saída é muito longa para mostrar aqui, mas como exemplo, veremos a primeira parte.</p>

<pre class="terminal">
$ rake rails:upgrade:check

(in /Users/eifion/rails/apps_for_asciicasts/ep225/railscasts)
Old router API
The router API has totally changed.
More information: http://yehudakatz.com/2009/12/26/the-rails-3-router-rack-it-up/

The culprits: 
	- config/routes.rb
</pre>	

<p>Antes de começarmos a atualização, vamos executar <code>rake rails:upgrade:backup</code>. Isso irá fazer backup de alguns dos principais arquivos que são suscetíveis de alteração durante a atualização.</p>

<pre class="terminal">
$ rake rails:upgrade:backup
(in /Users/eifion/rails/apps_for_asciicasts/ep225/railscasts)
DEPRECATION WARNING: Rake tasks in vendor/plugins/hoptoad_notifier/tasks are deprecated. Use lib/tasks instead. (called from /Library/Ruby/Gems/1.8/gems/rails-2.3.8/lib/tasks/rails.rb:10)

* backing up .gitignore to .gitignore.rails2
* backing up app/controllers/application_controller.rb to app/controllers/application_controller.rb.rails2
* backing up app/helpers/application_helper.rb to app/helpers/application_helper.rb.rails2
* backing up config/routes.rb to config/routes.rb.rails2
* backing up config/environment.rb to config/environment.rb.rails2
* backing up config/environments/development.rb to config/environments/development.rb.rails2
* backing up config/environments/production.rb to config/environments/production.rb.rails2
* backing up config/database.yml to config/database.yml.rails2

This is a list of the files analyzed and backed up (if they existed);
you will probably not want the generator to replace them since
you probably modified them (but now they&#x27;re safe if you accidentally do!).

- .gitignore
- app/controllers/application_controller.rb
- app/helpers/application_helper.rb
- config/routes.rb
- config/environment.rb
- config/environments/development.rb
- config/environments/production.rb
- config/environments/staging.rb
- config/database.yml
- config.ru
- doc/README_FOR_APP
- test/test_helper.rb
</pre>

<p>Começaremos a atualizar criando uma nova aplicação Rails 3 no diretório da aplicação. Para fazer isso, é necessário voltar ao ambiente do Ruby 1.9.2.</p>

<pre class="terminal">
$ rvm 1.9.2
</pre>

<p>Agora podemos criar a nova aplicação Rails 3 com:</p>

<pre class="terminal">
$ rails new .
</pre>

<p>Como estamos criando uma nova aplicação no mesmo diretório de uma existente, seremos questionados sobre sobrescrever alguns arquivos existentes. Se não temos certeza se o arquivo deve ser sobrescrito, podemos usar a opção <code>d</code> para ver as diferenças entre o arquivo existente e o que vai sobrescrever.</p>

<p>Nós fizemos backup dos arquivos mais importantes e podemos sobrescrever todos os arquivos conflitantes, exceto esses:</p>

<ul style="list-style-type:disc; list-style-position: inside;">
 <li><code>/README</code></li>
 <li><code>/app/views/layouts/application.html.erb</code></li>
 <li><code>/public/javascripts/application.js</code></li>
</ul>
 
<p>Os outros arquivos, ou não tiveram mudanças, ou têm backup, nos permitindo refazer quaisquer alterações na nova versão a medida que avançamos.</p>

<p>Nossa aplicação está agora atualizada para o Rails 3.0, mas ainda temos que percorrer os arquivos que fizemos backup e copiar qualquer código que seja específico da nossa aplicação. Cada arquivo que foi feito backup, está em seu diretório original com uma extensão <code>.rails2</code>. Então só precisamos abrir cada arquivo de backup, juntamente com a nova versão, e copiar os códigos que precisam ser mantidos.</p>

<p>Vamos começar com o arquivo de rotas. A sintaxe das rotos mudou, mas a antiga ainda funciona no Rails 3, embora esteja obsoleta (deprecated). Nesse momento podemos apenas copiar as rotas do arquivo de backup para o novo arquivo de rotas e vamos testar isso depois.</p>

<p>Em seguida vamos dar uma olhada no arquivo <code>/config/environment.rb</code>. Corrigir esse arquivo vai dar um pouco mais de trabalho, pois a configuração mudou bastante no Rails 3. O arquivo padrão dos ambientes está bem menor pois as opções de configuração não estão mais lá, foram para o arquivo <code>/config/application.rb</code>.</p>

<p>Existem três coisas no backup do <code>environment.rb</code> que precisamos considerar. A primeira é a configuração do time zone.</p>

<pre class="terminal">
config.time_zone = &#x27;Pacific Time (US &amp; Canada)&#x27;
</pre>

<p>Essa linha pode ser movida para o arquivo <code>/config/application.rb</code>.</p> 

<p>A segunda parte é o código da sessão.</p>

<pre class="terminal">
config.action_controller.session = {
  :session_key =&gt; APP_CONFIG[&#x27;session_key&#x27;],
  :secret      =&gt; APP_CONFIG[&#x27;session_secret&#x27;]
}
</pre>

<p>No Rails 3 esse código pertence a um arquivo initializer e se olharmos esse arquivo, vamos ver o código para configurar os dados de sessão da aplicação.</p>

<p class="codeFilePath">/config/initializers/session_store.rb</p>
<pre class="ruby">
# Be sure to restart your server when you modify this file.

Railscasts::Application.config.session_store :cookie_store, :key =&gt; &#x27;_railscasts_session&#x27;

# Use the database for sessions instead of the cookie-based default,
# which shouldn&#x27;t be used to store highly confidential information
# (create the session table with &quot;rake db:sessions:create&quot;)
# Railscasts::Application.config.session_store :active_record_store
</pre>

<p>Podemos deixar esse código como está por enquanto. Vamos alterar isso depois, mas isso não será necessário para ter o site instalado e funcionando.</p>

<p>Finalmente, no final do arquivo de backup do <code>environment.rb</code> está o código de configuração das gems da aplicação.</p>

<pre class="ruby">
config.gem &quot;RedCloth&quot;, :lib =&gt; &#x27;redcloth&#x27;, :version =&gt; &quot;&gt;= 4.0&quot;
config.gem &quot;coderay&quot;
config.gem &#x27;acts-as-list&#x27;
config.gem &#x27;will_paginate&#x27;
config.gem &#x27;thinking-sphinx&#x27;, :lib =&gt; &#x27;thinking_sphinx&#x27;
config.gem &#x27;whenever&#x27;, :lib =&gt; false
</pre>

<p>Esse código pode ser copiado para o <code>Gemfile</code>, que está no diretório raiz da aplicação. A sintaxe foi ligeiramente modificada e o código precisa ser alterado assim:</p>

<p class="codeFilePath">/Gemfile</p>
<pre class="ruby">
gem &quot;RedCloth&quot;, &quot;&gt;=4.0&quot;, :require =&gt; &#x27;redcloth&#x27;
gem &quot;coderay&quot;
gem &#x27;acts-as-list&#x27;
gem &#x27;will_paginate&#x27;
gem &#x27;thinking-sphinx&#x27;, :require =&gt; &#x27;thinking_sphinx&#x27;
gem &#x27;whenever&#x27;, :require =&gt; false
</pre>

<p>Além de alterar o <code>config.gem</code> para <code>gem</code> em cada linha, há algumas outras alterações que precisamos fazer. O número da versão agora é passado como segundo parâmetro e a opção <code>:lib</code> foi renomeada para <code>:required</code>.</p>

<p>Feito isso, precisamos executar <code>bundle install</code> para ter certeza de que todas as gems necessárias estão instaladas. Para mais informações sobre o bundler e instalação de gems você pode <a href="http://railscasts.com/episodes/201-bundler">assistir</a> ou <a href="http://asciicasts.com/episodes/201-bundler">ler</a> o episódio 201. Não vamos falar em copiar os códigos dos outros arquivos de backup, mas deve ser bastante simples transferir o código necessário do backup para o novo arquivo.</p>

<p>Com as gems instaladas, vamos tentar iniciar o servidor para ver se a aplicação será iniciada.</p>

<pre class="terminal">
$ rails s
/Users/eifion/.rvm/gems/ruby-1.8.7-p299/gems/will_paginate-2.3.14/lib/will_paginate.rb:39:in `enable_activerecord&#x27;: 
undefined method `returning&#x27; for WillPaginate:Module (NoMethodError)
# rest of error truncated&hellip;
</pre>

<p>Não foi. E o motivo foi um erro no código da gem <code>will_paginate</code>, onde temos um método <code>returning</code> indefinido. Esse método estava disponível no Rails 2, mas foi removido no Rails 3.</p>

<p>Em casos como esse, vale a pena chegar o site <a href="http://rubygems.org">RubyGems</a> para ver se há disponível uma nova versão da gem em prerelease compatível com o Rails 3. No caso do <code>will_paginate</code> existe e podemos usar, acrescentando o número da versão da gem em nosso <code>Gemfile</code>.</p>

<p class="codeFilePath">/Gemfile</p>
<pre class="terminal">
gem &#x27;will_paginate&#x27;, &#x27;&gt;=3.0.pre&#x27;
</pre>

<p>Se executarmos <code>bundle install</code> novamente, a versão prerelease da gem será instalada e poderemos usar. Agora podemos tentar iniciar o servidor de novo.</p>

<pre class="terminal">
$ rails s
/Users/eifion/.rvm/gems/ruby-1.8.7-p299/gems/after_commit-1.0.7/lib/after_commit/active_record.rb:15:in `include_after_commit_extensions&#x27;: undefined method `subclasses_of&#x27; for Object:Class (NoMethodError)
	from /Users/eifion/.rvm/gems/ruby-1.8.7-p299/gems/after_commit-1.0.7/lib/after_commit.rb:81
	from /Users/eifion/.rvm/gems/ruby-1.8.7-p299/gems/thinking-sphinx-1.3.18/lib/thinking_sphinx.rb:2:in `require&#x27;
	from /Users/eifion/.rvm/gems/ruby-1.8.7-p299/gems/thinking-sphinx-1.3.18/lib/thinking_sphinx.rb:2
</pre>

<p>Esse erro parece ter sido causado pela gem Thinking Sphinx. Novamente há uma versão prerelease disponível que podemos usar. Então temos que fazer outra alteração no <code>Gemfile</code> e daí executar o <code>bundle install</code> de novo.</p>

<p class="codeFilePath">/Gemfile</p>
<pre class="ruby">
gem &#x27;thinking-sphinx&#x27;, &#x27;&gt;=2.0.0.rc1&#x27;, :require =&gt; &#x27;thinking_sphinx&#x27;
</pre>

<p>Vamos tentar iniciar o servidor de novo.</p>

<pre class="terminal">
$ rails s
DEPRECATION WARNING: railtie_name is deprecated and has no effect. (called from &lt;class:Railtie&gt; at /Users/eifion/.rvm/gems/ruby-1.9.2-rc2/gems/will_paginate-3.0.pre/lib/will_paginate/railtie.rb:6)
=&gt; Booting WEBrick
=&gt; Rails 3.0.0.rc application starting in development on http://0.0.0.0:3000
=&gt; Call with -d to detach
=&gt; Ctrl-C to shutdown server
Exiting
/Users/eifion/rails/apps_for_asciicasts/ep225/railscasts/config/routes.rb:2:in `block in &lt;top (required)&gt;&#x27;: undefined local variable or method `map&#x27; for #&lt;ActionDispatch::Routing::Mapper:0x00000101dffde8&gt; (NameError)
</pre>

<p>Dessa vez temos algo novo. O servidor tenta iniciar mas reclama sobre uma variável ou método indefinido chamado <code>map</code> nas rotas. Conforme nós colamos o antigo código das rotas no novo arquivo de rotas, estamos usando uma variável <code>map</code>, mas a variável não é passada para o bloco, pois ela não é obrigatória no Rails 3. Nós ainda podemos usar a antiga sintaxe de rotas e passar essa variável.</p>

<p class="codeFilePath">/config/routes.rb</p>
<pre class="ruby">
Railscasts::Application.routes.draw do |map|
  map.resources :spam_questions

  map.resources :spam_checks

  map.with_options :controller =&gt; &#x27;info&#x27; do |info|
    info.about &#x27;about&#x27;, :action =&gt; &#x27;about&#x27;
    info.contest &#x27;contest&#x27;, :action =&gt; &#x27;contest&#x27;
    info.feeds &#x27;feeds&#x27;, :action =&gt; &#x27;feeds&#x27;
    info.give_back &#x27;give_back&#x27;, :action =&gt; &#x27;give_back&#x27;
  end
  
  map.login &#x27;login&#x27;, :controller =&gt; &#x27;sessions&#x27;, :action =&gt; &#x27;new&#x27;
  map.logout &#x27;logout&#x27;, :controller =&gt; &#x27;sessions&#x27;, :action =&gt; &#x27;destroy&#x27;
  
  map.resources :sponsors
  map.resources :comments
  map.resources :tags
  map.resources :episodes, :collection =&gt; { :archive =&gt; :get }
  map.resources :sessions
  map.resources :spam_reports, :member =&gt; { :confirm =&gt; :post }, :collection =&gt; { :confirm =&gt; :post }
  
  map.root :episodes
end
</pre>

<p>Quando tentamos iniciar o servidor pela quarta vez, temos sorte e ele inicia sem erros.</p>

<pre class="terminal">
$ rails s
DEPRECATION WARNING: railtie_name is deprecated and has no effect. (called from &lt;class:Railtie&gt; at /Users/eifion/.rvm/gems/ruby-1.9.2-rc2/gems/will_paginate-3.0.pre/lib/will_paginate/railtie.rb:6)
=&gt; Booting WEBrick
=&gt; Rails 3.0.0.rc application starting in development on http://0.0.0.0:3000
=&gt; Call with -d to detach
=&gt; Ctrl-C to shutdown server
[2010-08-05 19:30:22] INFO  WEBrick 1.3.1
[2010-08-05 19:30:22] INFO  ruby 1.9.2 (2010-07-11) [x86_64-darwin10.4.0]
[2010-08-05 19:30:22] INFO  WEBrick::HTTPServer#start: pid=9933 port=3000
</pre>

<p>Se visitarmos a página principal no navegador, vamos ver a página inicial padrão, pois ela foi recriada no diretório <code>/public</code> quando criamos a aplicação Rails 3. Podemos ver nessa página, que o ambiente correto está sendo usado.</p>

<div class="imageWrapper">
  <img src="/system/photos/439/original/E225I01.png" width="807" height="538" alt="The default home page of our updates application."/>
</div>

<p>Embora tenhamos iniciado o servidor com sucesso, ainda temos muitas coisas que precisamos corrigir, como vemos quando executamos <code>rails:upgrade:check</code> novamente. Também precisamos executar nossas <code>specs</code> de novo para ver se elas passam. Nós vamos fazer isso no próximo episódio.</p>