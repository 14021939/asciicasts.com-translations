<p>Ogni volta che si gestiscono delle date in un&rsquo;applicazione &egrave; spesso utile mettere a disposizione un calendario nell&rsquo;interfaccia utente. Se l&rsuqo;utente deve infatti scegliere una data per un certo campo, sar&agrave; sicuramente pi&ugrave; semplice per lui farlo da una popup che mostra un calendario, piuttosto che doverne inserire una scegliendo da una serie di tendine (giorno, mese e anno) o peggio ancora inserendo testualmente la data in un campo di testo. Pu&ograve; anche capitare che si abbia una tabella di modello nell&rsquo;applicazione che abbia un campo data e che quindi serva un calendario per permettere di scegliere per data fra i record di tale tabella. Vi mostreremo in questo episodio come poter fare entrembe le cose.</p>

<p>L&rsquo;applicazione con cui lavoreremo &egrave; una semplice applicazione di blogging che ha un certo numero di articoli a database, ma quasi tutte le applicazioni si aspettano che i campi di input per le date beneficino di questa funzionalit&agrave; di selezione. Quando creiamo o modifichiamo un articolo, possiamo scegliere una data di pubblicazione usando un classico date picker di Rails. Cambieremo questo sistema per poter usare un calendario in popup come metodo alternativo per scegliere tale data.</p>

<div class="imageWrapper">
  <img src="/system/photos/379/original/E213I01.png" width="804" height="539" alt="La pagina di modifica di un articolo con le tendine di scelta della data."/>
</div>

<p>I calendari sono complicati da creare e gestire da zero, ma per fortuna ci sono parecchie soluzioni di terze parti disponibili, che ci permetteranno di fare praticamente tutto ci&ograve; che vorremmo fare con i calendari e le date. Uno di questi &egrave; il plugin <a href="http://github.com/timcharper/calendar_date_select">calendar_date_select</a>. Questo plugin ci fornisce un metodo helper che funziona con le librerie Prototype e che invoca un calendario attraverso del JavaScript. Non useremo questo plugin, tuttavia, ma useremo piuttosto una soluzione diversa che fa uso di unobtrusive JavaScript e che si basa su jQuery. Non si tratta di una soluzione specifica per Rails, ma l&rsquo;abbiamo comunque scelta in quanto fornisce un metodo facile da capire per aggiungere un calendario ad un campo di data.</p>

<p>La libreria <a href="http://jqueryui.com/">jQuery UI</a> fornisce un <a href="http://jqueryui.com/demos/datepicker/">Datepicker</a> che permette l&rsquo;inclusione pulita di un calendario ad un qualunque campo di testo di una pagina. Quando il campo di testo ottiene il focus, o perch&egrave; viene selezionato con click, o perch&egrave; viene selezionato mediante tab da tastiera, una popup mostrante un calendario appare per consentire la selezione di una data. Una volta scelta in questo modo la data, il campo di testo si ritrova il valore selezionato impostato. Questo calendario pu&ograve; essere personalizzato mediante temi, usando il <a href="http://jqueryui.com/themeroller/">Themeroller</a> di jQuery: in questo modo ci viene data la possibilit&agrave; di scegliere l&rsquo;aspetto che pi&ugrave; ci piace. Se vogliamo ottenere rapidamente ci&ograve; che vogliamo, possiamo usare i file JavaScript e gli stili presenti sui server di Google per includere il codice jQueryUI ed uno dei temi di default. Dobbiamo solo referenziare i corretti file nella sezione HEAD della pagina di layout:</p>

<p class="codeFilePath">/app/views/layouts/application.html.erb</p>
<pre class="ruby">
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;en&quot; lang=&quot;en&quot;&gt;
&lt;head&gt;
  &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;/&gt;
  &lt;%= stylesheet_link_tag &quot;http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/redmond/jquery-ui.css&quot;, &quot;application&quot; %&gt;
  &lt;%= javascript_include_tag &quot;http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js&quot;, &quot;http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js&quot;, &quot;application&quot; %&gt;
  &lt;title&gt;&lt;%= yield :title %&gt;&lt;/title&gt;
&lt;/head&gt;
</pre>

<p>Si noti che l&rsquo;applicazione con cui lavoriamo qui &egrave; scritta in Rails 2. Se stessimo usando Rails 3, avremmo bisogno di aggiungere una versione compatibile con jQuery del file rails.js, come gi&agrave; trattato nell&rsquo;episodio 205 [<a href="http://railscasts.com/episodes/205-unobtrusive-javascript">guardalo</a>, <a href="http://it.asciicasts.com/episodes/205-javascript-non-appariscente">leggilo</a>].</p>

<p>Ora che abbiamo incluso le librerie jQuery e jQueryUI, possiamo cminciare a modificare la nostra applicazione per farla funzionare con il Datepicker. La prima cosa da fare &egrave; modificare il campo published_on nella form dell&rsquo;articolo, in modo tale che usi un <code>text_field</code> al posto di un <code>date_select</code>:</p>

<p class="codeFilePath">/app/views/articles/_form.html.erb</p>
<pre class="ruby">
&lt;%= f.label :published_on %&gt;
&lt;%= f.text_field :published_on %&gt;
</pre>

<p>Poi dobbiamo aggiungere un calendario in maniera non invasiva e lo possiamo fare aggiungendo del JavaScript al file <code>application.js</code>:</p>

<p class="codeFilePath">/public/javascripts/application.js</p>
<pre class="javascript">
$(function (){
	$(&#x27;#article_published_on&#x27;).datepicker();
});
</pre>

<p>Questo codice eseguir&agrave; al termine del caricamento del DOM, aggiungendo un date-picker ad ogni elemento che abbia <code>id</code> ugauale a <code>article_published_at</code>. Se ricarichiamo la pagina di modifica dell&rsquo;articoloe clicchiamo nel campo di testo <code>published_on</code>, vedremo la popup del calendario e potremo scegliere una data da quella popup:</p>

<div class="imageWrapper">
  <img src="/system/photos/380/original/E213I02.png" width="804" height="539" alt="I menu a tendina sono stati sostituiti da campi di testo con annesso calendario in popup."/>
</div>

<p>Al submit della form, Rails interpreter&agrave; la data dal valore presente nel campo di testo e aggiorner&agrave; la data relativa al campo <code>published_on</code> nella tabella articles sul database.</p>

<h3>Una vista calendario</h3>

<p>Now that we have our date picker working let&rsquo;s look at the other use of calendars we discussed: providing a calendar-based view of the articles in our application. This might not be the most efficient way of listing articles in a blog but we&rsquo;ll provide it as an alternative way of browsing the articles.</p>

<p>There are several solutions to this problem and finding the correct one depends on the needs of your application. If you need to show records that span multiple days then it&rsquo;s worth taking a look at the <a href="http://github.com/elevation/event_calendar">event_calendar plugin</a> which can display events that span a range of dates. If this functionality isn&rsquo;t required then a good alternative is the <a href="http://github.com/p8/table_builder">table_builder plugin</a>. This plugin offers a helper method called <code>calendar_for</code> that makes it easy to group a given set of records into days on a calendar. This is a better fit for our needs so we&rsquo;ll use it in our application.</p>

<p>We can install table_builder by running the following command:</p>
<pre class="terminal">
script/plugin install git://github.com/p8/table_builder.git
</pre>

<p>After it has installed we can begin to work on our calendar view by changing the <code>index</code> view in our articles controller. This currently looks like this:</p>

<p class="codeFilePath">/app/views/articles/index.html.erb</p>
<pre class="ruby">
&lt;% title &quot;Articles&quot; %&gt;
&lt;div id=&quot;articles&quot;&gt;
&lt;% @articles.each do |article| %&gt;
  &lt;h2&gt;
    &lt;%= link_to h(article.title), article %&gt;
    &lt;span class=&quot;comments&quot;&gt;(&lt;%= pluralize(article.comments.count, &#x27;comment&#x27;) %&gt;)&lt;/span&gt;
  &lt;/h2&gt;
  &lt;div class=&quot;author&quot;&gt;from &lt;%=h article.author %&gt; on &lt;%= article.written_date.strftime(&#x27;%b %d, %Y&#x27;) %&gt;&lt;/div&gt;
  &lt;div class=&quot;content&quot;&gt;&lt;%= h(article.content) %&gt;&lt;/div&gt;
&lt;% end %&gt;
&lt;/div&gt;
&lt;p&gt;&lt;%= link_to &quot;New Article&quot;, new_article_path %&gt;&lt;/p&gt;
</pre>
<p>We&rsquo;ll replace the code that loops through each article and shows it with a call to <code>calendar_for</code> to display the articles in a calendar view.</p>

<p class="codeFilePath">/app/views/articles/index.html.erb</p>
<pre class="ruby">
&lt;% title &quot;Articles&quot; %&gt;

&lt;div id=&quot;calendar&quot;&gt;
  &lt;% calendar_for @articles do |calendar| %&gt;
    &lt;% calendar.day(:day_method =&gt; :published_on) do |date, articles| %&gt;
      &lt;%= date.day %&gt;
    &lt;% end %&gt;
  &lt;% end %&gt;
&lt;/div&gt;
</pre>

<p>We call <code>calendar_for</code> and pass it our collection of articles. The block is executed once and takes a <code>calendar</code> object so we can call <code>calendar.day</code> to loop through each day. We have to specify a property of the article that returns a date so that we can group the articles by day so we pass in a <code>:day_method</code> parameter with a value of <code>:published_on</code>. The block here has two parameters: a date and a list of the articles that were published on that day. We can put any code we like inside this block but for now we&rsquo;ll just output the date&rsquo;s day of the month.</p>

<p>If we reload the page now we won&rsquo;t see a list of articles but instead a list of dates that look a little like a calendar.</p>

<div class="imageWrapper">
  <img src="/system/photos/381/original/E213I03.png" width="800" height="289" alt="A very basic calendar generated by table_builder."/>
</div>

<p>This doesn&rsquo;t look very pretty yet, but we can add some <a href="http://github.com/ryanb/railscasts-episodes/blob/master/episode-213/blog/public/stylesheets/application.css">CSS</a> to improve the look of it.</p>

<div class="imageWrapper">
  <img src="/system/photos/382/original/E213I04.png" width="842" height="460" alt="The calendar after adding some styling."/>
</div>

<p>We can improve the usability of the calendar by adding the names of the days at the top, using the <code>calendar.head</code> method.</p>

<p class="codeFilePath">/app/views/articles/index.html.erb</p>
<pre class="ruby">
&lt;% title &quot;Articles&quot; %&gt;

&lt;div id=&quot;calendar&quot;&gt;
  &lt;% calendar_for @articles do |calendar| %&gt;
    &lt;%= calendar.head(&#x27;Sunday&#x27;, &#x27;Monday&#x27;, &#x27;Tuesday&#x27;, &#x27;Wednesday&#x27;, &#x27;Thursday&#x27;, &#x27;Friday&#x27;, &#x27;Saturday&#x27;)%&gt;
    &lt;% calendar.day(:day_method =&gt; :published_on) do |date, articles| %&gt;
      &lt;%= date.day %&gt;
    &lt;% end %&gt;
  &lt;% end %&gt;
&lt;/div&gt;
</pre>

<p>When we reload the page again the days of the week will have been added to the top of the calendar.</p>

<div class="imageWrapper">
  <img src="/system/photos/383/original/E213I05.png" width="842" height="460" alt="The calendar now shows the days of the week."/>
</div>

<p>As it stands our calendar can only show dates from the current month so next we&rsquo;ll add a month selector that shows the current month and has links on either side to allow us to change the month that&rsquo;s shown.</p>

<p>To do this we&rsquo;ll start in the articles controller&rsquo;s <code>index</code> action where we&rsquo;ll create a variable that will hold the date of the month that we want to display. For now we&rsquo;ll just set it to today&rsquo;s date.</p>

<p class="codeFilePath">/app/controllers/articles_controller.rb</p>
<pre class="ruby">
def index
  @articles = Article.all
  @date = Date.today
end
</pre>
<p>Next we&rsquo;ll alter the view so that the month and the links are shown.</p>

<p class="codeFilePath">/app/controllers/articles_controller.rb</p>
<pre class="ruby">
&lt;% title &quot;Articles&quot; %&gt;

&lt;div id=&quot;calendar&quot;&gt;
  &lt;h2 id=&quot;month&quot;&gt;
    &lt;%= link_to &quot;&lt;&quot;, :month =&gt; (@date.beginning_of_month-1).strftime(&quot;%Y-%m-01&quot;) %&gt;
    &lt;%= h @date.strftime(&quot;%B %Y&quot;) %&gt;
    &lt;%= link_to &quot;&gt;&quot;, :month =&gt; (@date.end_of_month+1).strftime(&quot;%Y-%m-01&quot;) %&gt;
  &lt;/h2&gt;
  &lt;% calendar_for @articles, :year =&gt; @date.year, :month =&gt; @date.month do |calendar| %&gt;
    &lt;%= calendar.head(&#x27;Sunday&#x27;, &#x27;Monday&#x27;, &#x27;Tuesday&#x27;, &#x27;Wednesday&#x27;, &#x27;Thursday&#x27;, &#x27;Friday&#x27;, &#x27;Saturday&#x27;) %&gt;
    &lt;% calendar.day(:day_method =&gt; :published_on) do |date, articles| %&gt;
      &lt;%= date.day %&gt;
    &lt;% end %&gt;
  &lt;% end %&gt;
&lt;/div&gt;
</pre>

<p>The links both point to the <code>index</code> action that is currently being shown but add a parameter to the query string called <code>month</code> that specifies the previous or next month. We can go back to the controller code now, check for the existence of that <code>month</code> parameter and use it to set the value of the <code>@date</code> variable if it exists.</p>

<p class="codeFilePath">/app/controllers/articles_controller.rb</p>
<pre class="ruby">
def index
  @articles = Article.all
  @date = params[:month] ? Date.parse(params[:month) ? Date.today
end
</pre>

<p>When we reload the page now we&rsquo;ll see the the month above the calendar and the arrows on either side of it that will allow us to navigate to other months.</p>

<div class="imageWrapper">
  <img src="/system/photos/384/original/E213I06.png" width="842" height="460" alt="The links for changing the month have now been added."/>
</div>

<p>Our calendar view now looks good but it&rsquo;s not showing the articles that exist for any given day. We already have access to the articles for a given day in the <code>calendar.head</code> block so we can loop through this collection and render a link to each article for that day in a list.</p>

<p class="codeFilePath">/app/views/articles/index.html.erb</p>
<pre class="ruby">
&lt;% calendar_for @articles, :year =&gt; @date.year, :month =&gt; @date.month do |calendar| %&gt;
  &lt;%= calendar.head(&#x27;Sunday&#x27;, &#x27;Monday&#x27;, &#x27;Tuesday&#x27;, &#x27;Wednesday&#x27;, &#x27;Thursday&#x27;, &#x27;Friday&#x27;, &#x27;Saturday&#x27;)%&gt;
  &lt;% calendar.day(:day_method =&gt; :published_on) do |date, articles| %&gt;
    &lt;%= date.day %&gt;
    &lt;ul&gt;
      &lt;% for article in articles %&gt;
        &lt;li&gt;&lt;%= link_to h(article.title), article %&gt;&lt;/li&gt;
      &lt;% end %&gt;
    &lt;/ul&gt;
  &lt;% end %&gt;
&lt;% end %&gt;
</pre>

<p>When we reload the page one last time we&rsquo;ll see the articles for each day listed and can click on each article&rsquo;s link to take us through to that article.</p>

<div class="imageWrapper">
  <img src="/system/photos/385/original/E213I07.png" width="842" height="488" alt="The articles are now listed in the calendar."/>
</div>

<p>That&rsquo;s it for this episode. As we&rsquo;ve shown it&rsquo;s easy to use calendars to select dates or to display a list of records by a date property. You&rsquo;re encouraged to consider using a calendar view like this when it fits with the data in your application.</p>
