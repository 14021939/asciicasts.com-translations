<head><base href='http://asciicasts.com'></head>

<p>Las imágenes de avatar juegan cada vez un papel más importante en la web, sobre todo en las aplicaciones sociales.  Si queremos añadir imágenes de avatar a una aplicación nuestra podríamos considerar el uso de <a href='http://en.gravatar.com'>Gravatar</a>, que proporciona una forma muy cómoda de hacerlo.  Lo único que tenemos que gestionar es una dirección de correo para cada usuario, y no hace falta que nos preocupemos de gestionar subida de archivos, recorte de imágenes, o que los usuarios suban imágenes inapropiadas, porque esto lo gestionará Gravatar.  Tan sólo le tenemos que dar una dirección de correo y nos devolverá el avatar de dicho usuario.</p>

<p>En este episodio integraremos Gravatar con una aplicación Rails sencilla que tiene un modelo <code>User</code>.  Ahora mismo dispone de tres usuarios, cada uno de ellos con una dirección de correo electrónico difernte y la acción <ocde>index</ocde> muestra una columna <code>avatar</code> que aparece marcada como pendiente.  Con Gravatar añadiremos una imagen de avatar para cada usuario.</p>

<div class="imageWrapper">
  <img src="/system/photos/531/original/E244I01.png" width="800" height="347" alt="La página de los usuarios de la aplicación."/>
</div>

<p>Están varias extensiones que permiten añadir Gravatar a Rails pero es algo tan fácil de hacer que no vamos a usar ninguna.  Empezaremos modificando el código de la vista que muestra la tabla anterior, que tiene el siguiente aspecto:</p>

<p class="codeFilePath">/app/views/users/index.html.erb</p>
<pre class="ruby">&lt;% for user in @users %&gt;
  &lt;tr&gt;
    &lt;td&gt;TODO&lt;/td&gt;
    &lt;td&gt;&lt;%= user.email %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &quot;Show&quot;, user %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &quot;Edit&quot;, edit_user_path(user) %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &quot;Destroy&quot;, user, :confirm =&gt; &#x27;Are you &crarr;
      sure?&#x27;, :method =&gt; :delete %&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;</pre>

<p>Cambiaremos el texto TODO de la primera celda de la table por una etiqueta <code>image_tag</code>.  La URL de la imagen vendrá dada por un método de ayuda que escribiremos llamado <code>avatar_url</code>, y que recibe como argumento un usuario.</p>

<p class="codeFilePath">/app/views/users/index.html.erb</p>
<pre class="ruby">&lt;% for user in @users %&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;%= image_tag avatar_url(user) %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= user.email %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &quot;Show&quot;, user %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &quot;Edit&quot;, edit_user_path(user) %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &quot;Destroy&quot;, user, :confirm =&gt; &#x27;Are you &crarr;
      sure?&#x27;, :method =&gt; :delete %&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;</pre>

<p>Escribamos a continuación el método <code>avatar_url</code> en la clase <code>ApplicationHelper</code>.  Lo único complicado aquí es generar el identificador que Gravatar espera recbiir.  Se trata de un <em>hash</em> MD5 en minúsculas generado a partir de la dirección de correo del usuario:</p>

<p class="codeFilePath">/app/helpers/application_helper.rb</p>
<pre class="ruby">module ApplicationHelper
  def avatar_url(user)
    gravatar_id = Digest::MD5::hexdigest(user.email).downcase
    &quot;http://gravatar.com/avatar/#{gravatar_id}.png&quot;
  end
end</pre>

<p>Si ahora se recarga la página veremos las imágenes de avatar de las dos cuentas de usuarios que tienen asociada una imagen de Gravatar.  Para el usuario que no lo tiene se muestra la imagen por defecto de Gravatar.</p>


<div class="imageWrapper">
  <img src="/system/photos/532/original/E244I02.png" width="800" height="539" alt="Ya aparecen las imágenes de Gravatar."/>
</div>

<h3>Personalización de las imágenes de Gravatar</h3>

<p>Hay varios parámetros que se pueden pasar en la solicitud de URL a Gravatar para modificar su comportamiento, se pueden encontrar los detalles en la  <a href="http://en.gravatar.com/site/implement/images">web de Gravatar</a>. Por ejemplo si se añade el parámetro <code>s</code> se puede modificar el tamaño de la imagen de avatar:</p>

<pre class="ruby">http://gravatar.com/avatar/9a295994737a47683a4da4ed47aef7dd.png?s=200</pre>

<p>La opción <code>d</code> se puede utilizar para pasar una imagen por defecto alternativa si no se encuentra un avatar para el usuario:</p>


<pre class="ruby">http://gravatar.com/avatar/84ce1adb94b67014236a909fa4c1269d.png?d=http%3A%2F%2Fasciicasts.com%2Fimages%2Frails.png</pre>

<p>También se puede pasar la opción <code>r</code> para modificar la clasificación de la imagen o, si nuestro sitio utiliza HTTPS podemos recuperar las imágenes de forma segura utilizando <code>https://segure.gravatar.com</code> como dominio de la URL.  Vamos a usar un par de estas opciones para modificar el tamaño de las imágenes de avatar a 48 píxeles, que es el mismo tamaño que utiliza Twitter, y suministrar una imagen distinta por defecto:</p>

<p class="codeFilePath">/application/helpers/application_helper.rb</p>
<pre class="ruby">module ApplicationHelper
  def avatar_url(user)
    default_url = &quot;#{root_url}images/guest.png&quot;
    gravatar_id = Digest::MD5::hexdigest(user.email).downcase
    &quot;http://gravatar.com/avatar/#{gravatar_id}.png?s=48&amp;d=#{CGI.escape(default_url)}&quot;
  end
end</pre>

<p>Si se recarga la página las imágenes aparecerán más pequeñas y se mostrará nuestra imagen por defecto para la cuenta que no tiene imagen de Gravatar.</p>

<div class="imageWrapper">
  <img src="/system/photos/533/original/E244I03.png" width="800" height="442" alt="Ahora se muestra nuestro avatar por defecto."/>
</div>

<h3>Uso de imágenes de otros sitios con OmniAuth</h3>

<p>Esta solución de imágenes de avatar funciona especialmente bien con OmniAuth.  Los que no estén familiarizados con OmniAuth encontrán información en el episodio 241 [<a href="http://railscasts.com/episodes/241-simple-omniauth">verlo</a>, <a href="http://asciicasts.com/episodes/241-simple-omniauth">leerlo</a>] donde se explicaba como empezar a usarlo con una aplicación Rails.  El motivo por el que OmniAuth funciona muy bien con Gravatar es que si un usuario inicia la sesión en nuestro sitio utilizando Facebook o Twitter ya tendrá una imagen de avatar de estos servicios, imagen que se puede recuperar utilizando la propiedad <code>image</code> del <em>hash</em> <code>user_info</code> devuelto por OmniAuth.  Si el usuario no ha iniciado sesión por uno de estos servicios, se puede utilizar Gravatar como último recurso de forma que todos los usuarios tengan algún avatar.</p>

<p>No añadiremos OmniAuth a esta aplicación, pero al menos hemos añadido un campo <code>avatar_url</code> al modelo <code>User</code> para simular este dato de OmniAuth.  Primero modificaremos uno de los usuarios para ponerle una imagen de avatar de Twitter.</p>

<div class="imageWrapper">
  <img src="/system/photos/534/original/E244I04.png" width="801" height="351" alt="Asignación de avatar_url de un usuario."/>
</div>

<p>A continuación tenemos que cambiar el método <code>avatar_url</code> de <code>ApplicationHelper</code> para que utilice el avatar almacenado de un usuario si está presente.</p>

<p class="codeFilePath">/app/helpers/application_helper.rb</p>
<pre class="ruby">module ApplicationHelper
  def avatar_url(user)
    if user.avatar_url.present?
      user.avatar_url
    else
      default_url = &quot;#{root_url}images/guest.png&quot;
      gravatar_id = Digest::MD5::hexdigest(user.email).downcase
      &quot;http://gravatar.com/avatar/#{gravatar_id}.png?s=48&amp;d=#{CGI.escape(default_url)}&quot;
    end
  end
end</pre>

<p>Al cargar la página veremos que ahora la cuenta con su imagen propia de avatar mostrará esta imagen mientras que las otras se obtendrán de Gravatar.</p>


<div class="imageWrapper">
  <img src="/system/photos/535/original/E244I05.png" width="802" height="468" alt="Ahora se muestra el avatar de Twitter."/>
</div>

<p>Y con esto concluye este episodio, breve pero esperamos que haya servido para que empecemos a considerar el uso de avatares en nuestras aplicaciones Rails.</p>

