<p>In this episode we&rsquo;ll show you a handy gem called Metric_fu. It is a compilation of several different tools that provide reports that show which parts of your code might need extra work. If you&rsquo;re looking to find out which parts of your application might need refactoring then these tools can be a great help. They also work well as part of an automated testing setup; you can automatically generate reports and evaluate your code as you write your application.</p>

<h3>Installation</h3>
<p>The Metric_fu gem can be installed from github. First we need to make sure that we&rsquo;ve added github to your gem sources. You can find out where gem will look for gems with</p>
<pre class="terminal">
gem sources
</pre>
<p>If github isn&rsquo;t listed as a source it can be added by runnung</p>
<pre class="terminal">
sudo gem sources -a http://gems.github.com
</pre>
<p>We can now install the gem.</p>
<pre class="terminal">
sudo gem install jscruggs-metric_fu
</pre>
<p>Metric_fu will install several other dependencies unless they are already present. These include Flay, Flog, Rcov, Reek, Facets and Roodi. These are the tools that Metric_fu uses to generate its reports and which we&rsquo;ll be covering a number of later.</p>

<p>Metric_fu provides a rake task that can be used to generate the reports and we&rsquo;ll need to require the Metric_fu task in our application. We can do this by either modifying the <code>Rakefile</code> or by creating a separate file and putting the code in there. We&rsquo;ll take the second option and create a file called <code>metric_fu.rake</code> in our application&rsquo;s <code>/lib/tasks</code> directory. In this file we&rsquo;ll add our <code>require</code> statement.</p>
<pre class="ruby">
begin
  require &#x27;metric_fu&#x27;
rescue LoadError
end
</pre>
<p>The <code>rescue</code> will ensure that an exception isn&rsquo;t raised if the gem isn&rsquo;t installed or can&rsquo;t be loaded. Without it if the gem isn&rsquo;t installed then running any rake task on our application will cause an error and the task will be aborted.</p>

<h3>Configuration</h3>

<p>The rake file we&rsquo;ve just created is also the place where we can add any configuration options for Metric_fu. We can configure which tools are run and specify options for each tool, such as which of our application&rsquo;s directories the tools should run against. If, for example, we only wanted to run Flog and have it just check the code under the <code>/app</code> directory then we could configure Metric_fu as follows.</p>
<pre class="ruby">
begin
  require &#x27;metric_fu&#x27;
  
  MetricFu::Configuration.run do |config|
    config.metrics = [:flog]
    config.flog = { :dirs_to_flog =&gt; [&#x27;app&#x27;] }
  end
  
rescue LoadError
end
</pre>
<p>There are more details about the configuration options you can specify in the configuration section of the <a href="http://metric-fu.rubyforge.org">Metric_fu home page</a>.</p> 

<h3>Running Metric-Fu</h3>

<p>We&rsquo;re going to run Metric_fu&rsquo;s reports against the Railscasts codebase. This can be downloaded from github at <a href="http://github.com/ryanb/railscasts/tree/master">http://github.com/ryanb/railscasts/tree/master</a>. Once we&rsquo;ve got the code we can add the <code>metric_fu.rake</code> file as described above and then run Metric_fu with</p>
<pre class="terminal">
rake metrics:all
</pre>
<p>You might have mixed results the first time you try this and see some error messages, but they should be descriptive enough so that you can work out what has gone wrong. If you&rsquo;re struggling to get it all working, then a good place to look for help is the Metric_fu <a href="http://groups.google.com/group/metric_fu">Google group</a>.</p>

<p>Once the rake task finished it should open a browser window containing a list of all of the reports that have been generated by each tool.</p>

<div class="imageWrapper">
  <img src="/system/photos/123/original/E166I01.png" width="789" height="416" alt="The list of reports that Metric_fu generates."/>
</div>

<p>We won&rsquo;t cover the output from all of the reports in this episode, but show a few examples that can help improve your code, starting with Flay.</p>

<h3>Flay</h3>

<p><a href="http://ruby.sadi.st/Flay.html">Flay</a> analyses your application&rsquo;s code and looks for structural similarities. Running it against the Railscasts code gives the following output.</p>

<div class="imageWrapper">
  <img src="/system/photos/124/original/E166I02.png"  width="789" height="416" alt="The output from Flay."/>
</div>

<p>In the report above Flay has found some code that could be a good candidate for refactoring. We&rsquo;ll take a look at the first match. According to Flay both the <code>Comment</code> and <code>SpamReport</code> classes have similarities at line 18 in each file. Let&rsquo;s take a look at the code and see what it has found.</p>
<pre class="ruby">
def matching_spam_reports
  conditions = []
  conditions &lt;&lt; &quot;comment_ip=#{self.class.sanitize(user_ip)}&quot; unless user_ip.blank?
  conditions &lt;&lt; &quot;comment_site_url=#{self.class.sanitize(site_url)}&quot; unless site_url.blank?
  conditions &lt;&lt; &quot;comment_name=#{self.class.sanitize(name)}&quot; unless name.blank?
  SpamReport.scoped(:conditions =&gt; conditions.join(&#x27; or &#x27;))
end
</pre>
<p class="title">The <code>matching_spam_reports</code> method in <code>comment.rb</code>.</p>
<pre class="ruby">
def matching_comments
  conditions = []
  conditions &lt;&lt; &quot;user_ip=#{self.class.sanitize(comment_ip)}&quot; unless comment_ip.blank?
  conditions &lt;&lt; &quot;site_url=#{self.class.sanitize(comment_site_url)}&quot; unless comment_site_url.blank?
  conditions &lt;&lt; &quot;name=#{self.class.sanitize(comment_name)}&quot; unless comment_name.blank?
  Comment.scoped(:conditions =&gt; conditions.join(&#x27; or &#x27;))
end
</pre>
<p class="title">The <code>matching_comments</code> method in <code>spam_report.rb</code>.</p>

<p>Both of the methods above are similar, but not identical. This is one of the clever features of Flay: it doesn&rsquo;t just check for duplicated code, it also finds similarities in your code. The two methods above are similar enough that they could possibly be refactored into a new method, but there are enough differences between them to argue that they should be left separate.</p>

<h3>Flog</h3>

<p>The next tool we&rsquo;ll look at is <a href="http://ruby.sadi.st/Flog.html">Flog</a>, which measures code complexity.</p> 

<div class="imageWrapper">
  <img src="/system/photos/125/original/E166I03.png" width="743" height="575" alt="The output from Flog."/>
</div>

<p>The report Flog generates lists each file in your application in order of its complexity. It&rsquo;s worth scrolling though the report and looking at the files that score highly in the Highest Score column. In the Railscasts code the highest mark is given to <code>enkoder.rb</code>, which is an external library, and can be ignored. The second highest mark is given to the <code>Episode</code> model class. If we look further down the report we&rsquo;ll see that Flog also provides a report on each class and its methods so that we can see which part of <code>Episode</code> is scoring highly.</p>

<div class="imageWrapper">
  <img src="/system/photos/126/original/E166I04.png" width="748" height="444" alt="Flog detail for a single method."/>
</div>

<p>One of <code>Episode</code>&rsquo;s methods, the <code>existing_download_attributes</code> setter, has quite a high score, so we&rsquo;ll take a look at its code.</p>
<pre class="ruby">
def existing_download_attributes=(download_attributes)
  downloads.reject(&amp;:new_record?).each do |download|
    attributes = download_attributes[download.id.to_s]
    if attributes
      download.attributes = attributes
    else
      downloads.delete(download)
    end
  end
end
</pre>
<p>As the score reflects, this method is fairly complicated and could be a good candidate for refactoring.</p> 

<h3>Rcov</h3>

<p>Unlike Flog and Flay which look at the quality of your code, Rcov examines your tests. Specifically it reports on how much of your application&rsquo;s code is covered by tests.</p> 

<div class="imageWrapper">
  <img src="/system/photos/127/original/E166I05.png" width="759" height="537" alt="The output from Rcov."/>
</div>

<p>There can be problems when using Rcov from Metric_fu as it can sometimes skip files. If you find that this is happening then Rcov can always be run separately instead. In the report the model class <code>episode.rb</code> scores less than 100% and if we scroll down the report we&rsquo;ll see the uncovered code outlined in red. Untested code could contain all sorts of errors that we don&rsquo;t know about so Rcov is a valuable tool for making sure that as much of your code as possible is covered by tests.</p>

<div class="imageWrapper">
  <img src="/system/photos/128/original/E166I06.png" width="759" height="537" alt="Code not covered by tests is shown in red."/>
</div>

<h3>Reek</h3>

<p><a href="http://wiki.github.com/kevinrutherford/reek">Reek</a> is a similar tool to Flay in that it looks for parts of your code that need work. It detects &ldquo;code smells&rdquo; in your application and reports on them. Common smells include code duplication, long methods and repeated calls. Reek provides a useful description of each problem which should make it easy for you to find them and refactor the offending code.</p>

<div class="imageWrapper">
  <img src="/system/photos/129/original/E166I07.png" width="908" height="550" alt="The scores for each method as shown by Reek."/>
</div>

<h3>Saikuro</h3>

<p>The last report we&rsquo;ll look at is the one provided by <a href="http://saikuro.rubyforge.org/">Saikuro</a>.</p>

<div class="imageWrapper">
  <img src="/system/photos/130/original/E166I08.png" width="750" height="585" alt="The report generated by Saikuro."/>
</div>

<p>Saikuro is similar to Flog in that it analyses the complexity of your code. As well as giving each method a score it usefully shows the number of lines in each method in your application which is a good way of finding the methods that may need refactoring.</p>

<h3>A Pinch of Salt</h3>

<p>While all of the reports above provide useful information about the state of your Rails applications it&rsquo;s important to remember not to take things too far and to try to make your code &ldquo;perfect&rdquo;. Code analysis isn&rsquo;t an exact science and none of the tools shown are perfect in themselves, so they should all be used as an aid to help you find the areas of your code that might need some work not as an absolute instruction that you must refactor a part of your application.</p>

<h3>Automation</h3>

<p>Finally, if you&rsquo;re using a continuous integration tool such as <a href="http://rubyforge.org/projects/cruisecontrolrb/">CruiseControl</a>, you can integrate Metric_fu so that its reports are generated automatically. For more details see the Usage section of the <a href="http://metric-fu.rubyforge.org/">Metric_fu home page</a>.</p>