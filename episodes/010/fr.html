<p>Dans cet épisode, nous allons parler de refactoring. Le refactoring (ou refactorisation en français dans le texte) c'est améliorer la conception du code sans modifier sa fonctionnalité. Ca peut se faire en supprimant les duplications ou en améliorant la lisibilité ou la maintenabilité.</p>
<p>Dans cette application, nous avons une liste d'utilisateurs. En cliquant sur un utilisateur, on peut voir son profil. Notez que certains utilisateurs ont une initiale dans leur nom alors que les autres n'en ont pas.</p>
<img src="/system/photos/8/original/E010I01.png" title="The index and show views for the User model." alt="The index and show views for the User model." width="800" height="400" />
<p class="title">Les vues <code>index</code> et <code>show</code> dans le navigateur.</p>
<p>Regardons le code de la vue. D'abord, le code de la vue <code>index</code> :</p>
<pre class="ruby">
&lt;h1&gt;Users&lt;/h1&gt;
&lt;ul&gt;
&lt;% for user in @users %&gt;
&lt;li&gt;
  &lt;a href="&lt;%= user_path(user) %&gt;"&gt;
    &lt;%= user.first_name %&gt;
    &lt;%= "#{user.middle_initial}." unless user.middle_initial.nil? %&gt;
    &lt;%= user.last_name %&gt;
  &lt;/a&gt;
&lt;/li&gt;
&lt;% end %&gt;
&lt;/ul&gt;
</pre>
<p class="title">Le code de la vue <code>index</code></p>
<p>Le code ci-dessus récupère tous les utilisateurs, puis une boucle les parcourt tous. Les trois lignes avec l'élément<code>&lt;a&gt;</code> affichent le nom de l'utilisateur. Maintenant, regardons la page du profil.</p>
<pre class="ruby">
&lt;h1&gt;Profile&lt;/h1&gt;
&lt;p&gt;
  Name:
  &lt;%= @user.first_name %&gt;
  &lt;%= "#{@user.middle_initial}." unless @user.middle_initial.nil? %&gt;
  &lt;%= @user.last_name %&gt;
&lt;/p&gt;
&lt;%= link_to 'Users List', users_path %&gt;
</pre>
<p class="title">Le code de la vue de l'action <code>show</code></p>
<p>La page de profil a les même trois lignes pour afficher le nom de l'utilisateur que la page d'index. Ceci est clairement une duplication et est un bon candidat pour du refactoring. Le code pour afficher le nom de l'utilisateur divise le nom en trois parties. Ceci est fait pour que l'initiale puisse être affichée avec un point, sauf si l'utilisateur n'a pas d'initiale.</p>

<h3>Comment commencer le refactoring ?</h3>
<p>Un moyen de refactoriser ce code serait de le déplacer dans un helper mais il n'y pas de HTML dans le code, uniquement le nom de l'utilisateur qui est lié au modèle <code>User</code>. La place idéale pour placer ce code serait donc dans le modèle <code>User</code>. Créons une méthode dans le modèle <code>User</code> nommée <code>full_name</code>. Nous allons commencer par déplacer le code répété des vues <code>index</code> et <code>show</code>, mettre les trois parties du nom dans une variable locale puis retourner la variable locale.</p>
<pre class="ruby">
class User &lt; ActiveRecord::Base
  def full_name
    name = first_name + ' '
    name += "#{middle_initial}. " unless middle_initial.nil?
    name += last_name
    name
  end
end
</pre>
<p class="title">Le modèle <code>User</code> après avoir ajouté la méthode <code>full_name</code>.</p>
<p>Puisque nous avons déplacé le code dans le modèle <code>User</code> la variable <code>@user</code> ne peut pas être référencée. Mais, puisque nous appelons les méthodes dans le modèle <code>User</code>, nous pouvons tout simplement enlever cette variable.</p>

<h3>Est-ce que notre refactoring fonctionne ?</h3>
<p>Maintenant que nous avons écrit notre méthode <code>full_name</code> nous pouvons remplacer le code dans nos méthodes <code>index</code> et <code>show</code>. Regardons la partie concernées de la vue <code>index</code>.</p>
<pre class="ruby">
&lt;a href="&lt;%= user_path(user) %&gt;"&gt;
  &lt;%= user.full_name %&gt;
&lt;/a&gt;
</pre>
<p class="title">La vue <code>index</code> avec la méthode <code>full_name</code>.</p>
<p>Il y a une autre façon d'améliorer le code ci-dessus. Puisque nous avions un code assez complexe pour générer le nom de l'utilisateur nous devions utiliser le tag standard HTML <code>&lt;a&gt;</code>, plutôt que <code>link_to</code>. Maintenant, nous pouvons utiliser <code>link_to</code> et simplifier le code de la vue encore un peu plus.</p>
<pre class="ruby">&lt;%= link_to user.full_name, user_path(user) %&gt;</pre>
<p class="title">La vue <code>index</code> avec <code>link_to</code>.</p>
<p>Le code dans le modèle <code>User</code> et sa vue sont maintenant optimisé par rapport à ce que nous avions au début. Nous avons supprimé la duplication et déplacer le code lié à l'utilisateur qui appartient au modèle dans le modèle <code>User</code>. Il y a toujours de la place pour de l'optimisation, et nous verrons comment le code peut encore être amélioré dans le prochain épisode.</p>

<h3>Le code après refactorisation</h3>
<pre class="ruby">
class User &lt; ActiveRecord::Base
  def full_name
    name = first_name + ' '
      name += "#{middle_initial}. " unless middle_initial.nil?
      name += last_name
      name
  end
end
</pre>
<p class="title">Le modèle <code>User</code> après refactorisation.</p>
<pre class="ruby">
&lt;h1&gt;Users&lt;/h1&gt;
&lt;ul&gt;
&lt;% for user in @users %&gt;
    &lt;li&gt;&lt;%= link_to user.full_name %&gt;&lt;/li&gt;
&lt;% end %&gt;
&lt;/ul&gt;
</pre>
<p class="title">La vue <code>index</code> après refactorisation.</p>

<pre class="ruby">
&lt;h1&gt;Profile&lt;/h1&gt;
&lt;p&gt;Name: &lt;%= @user.full_name %&gt;&lt;/p&gt;
&lt;%= link_to 'Users List', users_path %&gt;
</pre>
<p class="title">La vue <code>show</code> après refactorisation.</p>