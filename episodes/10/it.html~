<p>In questo episodio discuteremo di refactoring. Il refactoring &egrave; il miglioramente del progetto del codice senza cambiare le sue funzionalit&agrave;. Pu&ograve; essere fatto per rimuovere duplicazioni di codice o per migliorare la leggibilit&agrave; o la manutenibilit&agrave;.</p>
<p>In questa applicazione abbiamo una lista di utenti. Cliccando su un utente, viene mostrato il suo profilo. Si noti che alcuni utenti hanno una iniziale di doppio nome, mentre altri no.</p>
<img src="/system/photos/8/original/E010I01.png" title="Le viste index e show per il modello User." alt="Le viste index e show per il modello User." width="800" height="400" />
<p class="title">Le viste index e show per il modello User.</p>
<p>Diamo un&rsquo;occhiata al codice della vista. Per prima cosa, il codice della vista index:</p>
<pre class="ruby">
&lt;h1&gt;Users&lt;/h1&gt;
&lt;ul&gt;
&lt;% for user in @users %&gt;
&lt;li&gt;
  &lt;a href="&lt;%= user_path(user) %&gt;"&gt;
    &lt;%= user.first_name %&gt;
    &lt;%= "#{user.middle_initial}." unless user.middle_initial.nil? %&gt;
    &lt;%= user.last_name %&gt;
  &lt;/a&gt;
&lt;/li&gt;
&lt;% end %&gt;
&lt;/ul&gt;
</pre>
<p class="title">Il codice della vista index</p>
<p>Il codice precedente prende tutti gli utenti, poi itera su di loro. Le tre linee all&rsquo;interno dell&rsquo;elemento &lt;a&gt; mostra il nome dell&rsquo;utente. Ora vediamo la pagina del profilo.</p>
<pre class="ruby">
&lt;h1&gt;Profile&lt;/h1&gt;
&lt;p&gt;
  Name:
  &lt;%= @user.first_name %&gt;
  &lt;%= "#{@user.middle_initial}." unless @user.middle_initial.nil? %&gt;
  &lt;%= @user.last_name %&gt;
&lt;/p&gt;
&lt;%= link_to 'Users List', users_path %&gt;    
</pre>
<p class="title">Il codice della vista per l&rsquo;action show</p>
<p>The profile page has the same three lines of code to display a user&rsquo;s name as the index page. This is obvious duplcation and a good candidate for refactoring. The code to display the user&rsquo;s name splits the name up into three parts. This is done so that the middle initial can be shown with a full stop after it, unless the user has no middle initial.</p>

<h3>How do we begin refactoring?</h3>
<p>One way to refactor this code would be to move it into a helper method, but there is no HTML in the code, just the user&rsquo;s name, which is related to the <code>User</code> model. The ideal place to put this repeated code would therefore be in the user model. Let&rsquo;s create a method in the user model called <code>full_name</code>. We&rsquo;ll start by moving the repeated code from the index and show views, put the three parts of the name into a local variable, then return the local variable.</p>
<pre class="ruby">
class User &lt; ActiveRecord::Base
  def full_name
    name = first_name + ' '
    name += "#{middle_initial}. " unless middle_initial.nil?
    name += last_name 
    name
  end
end
</pre> 
<p class="title">The User model after we&rsquo;ve added the <code>full_name</code> method.</p>
<p>As we&rsquo;ve moved the code into the <code>user</code> model the <code>@user</code> variable can&rsquo;t be referenced. But, as we&rsquo;re calling methods in the <code>User</code> model so we can simply remove it.</p>

<h3>Does our refactor work?</h3>
<p>Now that we&rsquo;ve written our <code>full_name</code> method we can replace the code in our <code>index</code> and <code>show</code> methods. Let&rsquo;s look at the relevant part of the <code>index</code> view.</p>
<pre class="ruby">
&lt;a href="&lt;%= user_path(user) %&gt;"&gt;
  &lt;%= user.full_name %&gt;
&lt;/a&gt;
</pre>
<p class="title">The index view with the <code>full_name</code> method.</p>
<p>There&rsquo;s another way we can improve the code above. Because we had such complex code to generate the user name we had to use a standard HTML &lt;a&gt; tag, rather than <code>link_to</code>. Now, we can use <code>link_to</code> and simpify the view code even further.</p>
<pre class="ruby">&lt;%= link_to user.full_name, user_path(user) %&gt;</pre>
<p class="title">The index view with <code>link_to</code>.</p>
<p>The code in the <code>User</code> model and its views is now much improved from where we started. We&rsquo;ve removed duplication and moved user-related code that belongs in the model in to the <code>User</code> model. There&rsquo;s still room for improvement though, and we&rsquo;ll see how the code can be improved further in the next episode.</p>

<h3>The code after refactoring</h3>
<pre class="ruby">
class User &lt; ActiveRecord::Base
  def full_name
    name = first_name + ' '
      name += "#{middle_initial}. " unless middle_initial.nil?
      name += last_name 
      name
  end
end
</pre>
<p class="title">The <code>User</code> model after refactoring.</p>
<pre class="ruby">
&lt;h1&gt;Users&lt;/h1&gt;
&lt;ul&gt;
&lt;% for user in @users %&gt;
    &lt;li&gt;&lt;%= link_to user.full_name %&gt;&lt;/li&gt;
&lt;% end %&gt;
&lt;/ul&gt;
</pre>
<p class="title">The <code>index</code> view after refactoring.</p>

<pre class="ruby">
&lt;h1&gt;Profile&lt;/h1&gt;
&lt;p&gt;Name: &lt;%= @user.full_name %&gt;&lt;/p&gt;
&lt;%= link_to 'Users List', users_path %&gt;
</pre>
<p class="title">The <code>show</code> view after refactoring.</p>
