<head><base href="http://asciicasts.com"></head>

<p>A los que hayan usado Rails alguna vez les resultarán familiares los generadores y habrán utilizado el comando <code>script/generate</code> para crear modelos, controladores, andamiajes, etcétera.  En Rails 3 se han reescrito por completo los generadores y son totalmente diferentes de los de la versión 2.   De entrada ahora son mucho más modulares lo que quiere decir que son más fáciles de adaptar según nuestras preferencias.</p>

<p>Si ejecutamos <code>rails g</code> desde el directorio raíz de una aplicación Rails 3 veremos la lista de los generadores disponibles en esa aplicación.  Si no hemos creado nuestros propios generadores tan sólo veremos los generadores incluidos en Rails 3: <code>controller</code>, <code>generator</code>, <code>helper</code>, <code>integration_test</code>, <code>mailer</code>, <code>metal</code>, <code>migration</code>, <code>model</code>, <code>observer</code>, <code>performance_test</code>, <code>plugin</code>, <code>resource</code>, <code>scaffold</code>, <code>scaffold_controller</code>, <code>session_migration</code> and <code>stylesheets</code>.  En su mayoría estos generadores se comportan igual que sus equivalentes en Rails 2.</p>

<p>Para ver la ayuda disponible de un generador concreto, podemos ejecutar el generador con la opción <code>--help</code>.  Si lo intentamos con el generador de andamiajes veremos que hay muchas opciones disponibles las cuales nos dan bastante flexibilidad para personalizar el comportamiento del generador.</p>

<pre class="terminal">
$ rails g scaffold --help
Usage:
  rails generate scaffold NAME [field:type field:type] [options]

Options:
  -c, --scaffold-controller=NAME  # Scaffold controller to be invoked
                                  # Default: scaffold_controller
      [--singleton]               # Supply to create a singleton controller
      [--force-plural]            # Forces the use of a plural ModelName
  -y, [--stylesheets]             # Indicates when to generate stylesheets
                                  # Default: true
  -o, --orm=NAME                  # Orm to be invoked
                                  # Default: active_record

ScaffoldController options:
  -e, [--template-engine=NAME]  # Template engine to be invoked
                                # Default: erb
      [--helper]                # Indicates when to generate helper
                                # Default: true
  -t, [--test-framework=NAME]   # Test framework to be invoked
                                # Default: test_unit

Runtime options:
  -f, [--force]    # Overwrite files that already exist
  -p, [--pretend]  # Run but do not make any changes
  -q, [--quiet]    # Supress status output
  -s, [--skip]     # Skip files that already exist

TestUnit options:
  -r, [--fixture-replacement=NAME]  # Fixture replacement to be invoked
      [--fixture]                   # Indicates when to generate fixture
                                    # Default: true

ActiveRecord options:
  [--parent=PARENT]  # The parent class for the generated model
  [--timestamps]     # Indicates when to generate timestamps
                     # Default: true
  [--migration]      # Indicates when to generate migration
                     # Default: true
</pre>

<p>Nótese que algunas opciones tienen valore spor defecto.  Por ejemplo la opción  <code>--stylesheets</code> por defecto vale <code>true</code>.  Pero, ¿y si on creemos que se generen automáticamente las hojas de estilo?  Pues bien, cuando tenemos una opción booleana cuyo valor por defecto es <code>true</code> podemos poner el prefijo <code>--no</code> para desactivar dicha opción.  A continuación creareemos un andamiaje llamado  <code>project</code> sin hoja de estilos.</p>

<pre class="terminal">
$ rails g scaffold project name:string --no-stylesheets
      invoke  active_record
      <span class="passed">create</span>    db/migrate/20100602201538_create_projects.rb
      <span class="passed">create</span>    app/models/project.rb
      invoke    test_unit
      <span class="passed">create</span>      test/unit/project_test.rb
      <span class="passed">create</span>      test/fixtures/projects.yml
       route  resources :projects
      invoke  scaffold_controller
      <span class="passed">create</span>    app/controllers/projects_controller.rb
      invoke    erb
      <span class="passed">create</span>      app/views/projects
      <span class="passed">create</span>      app/views/projects/index.html.erb
      <span class="passed">create</span>      app/views/projects/edit.html.erb
      <span class="passed">create</span>      app/views/projects/show.html.erb
      <span class="passed">create</span>      app/views/projects/new.html.erb
      <span class="passed">create</span>      app/views/projects/_form.html.erb
      invoke    test_unit
      <span class="passed">create</span>      test/functional/projects_controller_test.rb
      invoke    helper
      <span class="passed">create</span>      app/helpers/projects_helper.rb
      invoke      test_unit
      <span class="passed">create</span>        test/unit/helpers/projects_helper_test.rb
</pre>      

<p>Si inspeccionamos la salida del comando veremos que no se han generado hojas de estilo porque hemos desactivado la opción.</p>

<p>La salida del generador muestra (además del listado de los archivos que se han creado) una serie de llamadas a <code>invoke</code>.  Estas líneas indican cuándo se están invocando otros generadores.  Esto quiere decir que el generador de andamiajes no hace mucho por sí solo, sino que delega en otros generadores como el generador <code>active_record</code> que crea el archivo del modelo y la migración.  El generador <code>active_record</code> llama a otro generador <code>test_unit</code>, para crear un fichero de test de unidad.  Este patrón se repite más abajo cuando el generador <code>scaffold_controller</code> invoca los generadores <code>erg</code>, <code>test_unit</code> y <code>helper</code> para crear el resto de archivos conectados con un controlador y sus vistas.  Esto hace que este sistema sea muy modular y podemos reemplazar lo que nos interese.  Por ejemplo si queremos utilizar Haml en lugar de erb en las vistas, o Should o RSpec en lugar de Test::Unit podríamos utilizar esos generadores.</p>

<p>Con esto, ya podemos repasar otra vez la lista de opciones que nos muestra el generador de andamiajes y deberían empezar a adquirir má sentido.  Por ejemplo la opción  <code>--orm</code> nos permite cambiar el mapeo objeto-relacional que generará nuestros modelos (podríamos usar DataMapper en lugar de ActiveRecord).  Más abajo en la lista de opciones hay una lista de opciones de ActiveRecrod que sólo aplican a la versión de ActiveRecord del generador así como las opciones de los generadores de Test::Unit y ScaffoldController.</p>

<h3>Cambio de las opciones por defecto</h3>

<p>Aunque poder pasar a los generadores opciones como <code>--no-stylesheets</code> es bastante útil, sería bastnatemás útil si pudiéramos cambiar las opciones por defecto, cosa que podemos hacer en Rails 3 (a nivel de aplicación) modificando el archivo <code>application.rb</code>  El fichero <code>application.rb.</code> generado automáticamente cuando se crea la aplicación tien la siguiente sección comentada:</p>

<p class="codeFilePath">/config/application.rb</p>
<pre class="ruby">
# Configure generators values. Many other options are available, be sure to check the documentation.
# config.generators do |g|
#   g.orm             :active_record
#   g.template_engine :erb
#   g.test_framework  :test_unit, :fixture =&gt; true
# end
</pre>

<p>Si quitamos los comentarios de esta sección podemos cambiar las opciones por defecto de los generadores en nuestra aplicación.  Las opciones que se muestran coinciden con los valores por defectos.  Por ejemplo para desactivar la generación de hojas de estilo por defecto podríamos escribir:</>

<p class="codeFilePath">/config/application.rb</p>
<pre class="ruby">
# Configure generators values. Many other options are available, be sure to check the documentation.
config.generators do |g|
  g.stylesheets false
end
</pre>

<p>Si ahora ejecutamos el comando <code>help</code> en el generador de andamiajes veremos que la nueva opción por defecto entra en acción y la opción  <code>--stylesheets</code> no tendrá el valor por defecto <code>true</code>.</p>

<pre class="terminal">
$ rails g scaffold --help
Usage:
  rails generate scaffold NAME [field:type field:type] [options]

Options:
  -y, [--stylesheets]             # Indicates when to generate stylesheets
  -c, --scaffold-controller=NAME  # Scaffold controller to be invoked
                                  # Default: scaffold_controller
      [--singleton]               # Supply to create a singleton controller
      [--force-plural]            # Forces the use of a plural ModelName
  -o, --orm=NAME                  # Orm to be invoked
                                  # Default: active_record
</pre>

<p>Hagamos algo un poco más a la aventura, cambiemos el <em>framework</em> de pruebas para que sea Shoulda en lugar de Test::Unit, y vamos a cambiar las <em>fixturas</em> por Factory Girl usando la opción <code>fixture-replacement</code>.</p>

<p>Por supuesto antes de hacer esto tenemos que detallar cuáles son las gemas relevantes en el fichero <code>Gemfile</code> de la aplicación.  Tan sólo necesitaremos estas gemeras en el entorno de test, así que las agruparemos.</p>

<p class="codeFilePath">/Gemfile</p>
<pre class="ruby">
group :test do
  gem &quot;shoulda&quot;
  gem &quot;factory_girl&quot;
end
</pre>

<p>Por desgracias estas dos gemas no incluyen generadores para Rails 3 pero podemos utilizar otra gema llamada <a href="http://github.com/indirect/rails3-generators">rails3-generators</a> que sí que incluye generaores adaptados a Rails 3 de muchos <em>plugins</em> y gemas, incluyendo Shoulda y Factory Girl.  Vamos a añadir dicha gema también al fichero Gemfile pero sólo lo haremos en el entorno de desarrollo.</p>

<p class="codeFilePath">/Gemfile</p>
<pre class="ruby">
gem &quot;rails3-generators&quot;, :group =&gt; :development
</pre>
<p>Con esto, sólo tenemos que ejecutar</p>

<pre class="terminal">
bundle install
</pre>

<p>para instalar las gemas.  Una vez que se hayan instalado las gemas podemos ejecutar <code>rails g</code> para ver una lista de los generadores que hay disponibles.  Al final de la lista ahora deberían aparecer los nuevos generadores definidos en la gema <code>rails3-generators</code>.</p>

<p>Con estos nuevos generadores podemos modificar la configuración de  <code>application.rb</code> y poner los valores por defecto de las opciones  <code>test_framework</code> y <code>fixture_replacement</code>.</p>

<p class="codeFilePath">/config/application.rb</p>
<pre class="ruby">
# Configure generators values. Many other options are available, be sure to check the documentation.
config.generators do |g|
  g.stylesheets false
  g.test_framework :shoulda
  g.fixture_replacement :factory_girl
end
</pre>

<p>Ahora cuando ejecutemos la ayuda del generador de andamiajes otra vez veremos que habrá cambiado para mostrar las opciones por defecto de <em>framework</em> de pruebas.</p>

<pre class="terminal">
$ rails g scaffold --help
Usage:
  rails generate scaffold NAME [field:type field:type] [options]
  ...

ActiveRecord options:
  [--parent=PARENT]      # The parent class for the generated model
  [--migration]          # Indicates when to generate migration
                         # Default: true
  [--timestamps]         # Indicates when to generate timestamps
                         # Default: true
  [--textframework=NAME] # Test framework to be invoked
                         # Default: shoulda

Shoulda options:
  [--fixture-replacement=NAME]  # Fixture replacement to be invoked
                                # Default: factory_girl
  [--dir=DIR]                   # The directory where the model tests should go
                                # Default: test/unit
</pre>                              

<p>Podemos probar todo esto generando un nuevo andamiaje para un modelo llamado <code>task</code>.</p>

<pre class="terminal">
$ rails g scaffold task project_id:integer name:string
      invoke  active_record
      <span class="passed">create</span>    db/migrate/20100604202823_create_tasks.rb
      <span class="passed">create</span>    app/models/task.rb
      invoke    shoulda
      <span class="passed">create</span>      test/unit/task_test.rb
      invoke      factory_girl
      <span class="passed">create</span>        test/factories/tasks.rb
       route  resources :tasks
      invoke  scaffold_controller
      <span class="passed">create</span>    app/controllers/tasks_controller.rb
      invoke    erb
      <span class="passed">create</span>      app/views/tasks
      <span class="passed">create</span>      app/views/tasks/index.html.erb
      <span class="passed">create</span>      app/views/tasks/edit.html.erb
      <span class="passed">create</span>      app/views/tasks/show.html.erb
      <span class="passed">create</span>      app/views/tasks/new.html.erb
      <span class="passed">create</span>      app/views/tasks/_form.html.erb
       <span class="failed">error</span>    shoulda [not found]
      invoke    helper
      <span class="passed">create</span>      app/helpers/tasks_helper.rb
       <span class="failed">error</span>      shoulda [not found]
</pre> 

<p>Al principio vemos que se invocan correctamente los generadores de <code>shoulda</code> y <code>factory_girl</code> pero que más abajo, no se pudo encontrar un generador de Shoulda para erb o el fichero <em>helper</em>.  Si vemos otra vez la lista de <em>helpers</em> eremos que sólo tenemos generadores Shoulda para los modelos y los controladores.</p>

<pre class="terminal">
$ rails g
  ...
Shoulda:
  shoulda:controller
  shoulda:model
</pre>  

<p>¿Qué podemos hacer aquí?  Bueno, si examinamos la página de las <a href="http://guides.rails.info/generators.html#adding-generators-fallbacks">Guías Rails sobre generadores</a> veremos que es posibile añadir generadores de respaldo por si no se encuentran ciertos generaores.  Nuevamente, lo único que hay que hacer es modificar el bloque de configuración en <code>application.rb</code>.</p>

<p class="codeFilePath">/config/application.rb</p>
<pre class="ruby">
# Configure generators values. Many other options are available, be sure to check the documentation.
config.generators do |g|
  g.stylesheets false
  g.test_framework :shoulda
  g.fallbacks[:shoulda] = :test_unit 
  g.fixture_replacement :factory_girl
end
</pre>

<p>Ahora ya podemos generar andamiajes con Shoulda y los generadores utilizarán los generadores correspondientes a Test::Unit si no se puede encontrar un generador adecuado de Shoulda.</p>

<h3>Personalización de las plantillas</h3>

<p>Los últimos que nos queda por ver en este episodio es cómo personalizar las plantillas generadas.  Debajo se muestra la vista generada para la acción <code>index</code> del controlador que acabamos de generar.</p>

<p class="codeFilePath">/app/views/tasks/index.html.erb</p>
<pre class="ruby">
&lt;h1&gt;Listing tasks&lt;/h1&gt;

&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;&lt;/th&gt;
    &lt;th&gt;&lt;/th&gt;
    &lt;th&gt;&lt;/th&gt;
  &lt;/tr&gt;

&lt;% @tasks.each do |task| %&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;%= link_to &#x27;Show&#x27;, task %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &#x27;Edit&#x27;, edit_task_path(task) %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &#x27;Destroy&#x27;, task, :confirm =&gt; &#x27;Are you sure?&#x27;, :method =&gt; :delete %&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;
&lt;/table&gt;

&lt;br /&gt;

&lt;%= link_to &#x27;New Task&#x27;, new_task_path %&gt;
</pre>

<p>Supongamos que queremos eliminar la etiqueta <code>br</code> al final de la plantilla y poner el enlace del final en su párrafo.  ¿Cómo podemos cambiar la plantilla de forma que estos cambios ocurran en todas las vistas generadas?</p>

<p>Podemos crear nuestras propias plantillas en un directorio llamado <code>templates</code> dentro del directorio <code>lib</code>.  Los generadores mirarán ahí en busca de plantillas en lugar de utilizar las incluidas por defecto.  Para determinar qué plantilla tenemos que redefinir tendremos que mirar <a href="http://github.com/rails/rails">el código fuente del generador</a>.  El código de los generadores está en el directorio  <a href="http://github.com/rails/rails/tree/master/railties/lib/rails/generators/">railties/lib/rails/generators</a> y las plantillas por defecto están en el directorio <a href="http://github.com/rails/rails/tree/master/railties/lib/rails/generators/erb/scaffold/templates/">erb/scaffold/templates/</a>.  Podemos copiar los contenidos de <code>index.html.erb</code> de ese directorio para cambiarlo según convenga.</p>

<p>Tenemos que crear una estructura de directorios similar por lo que nuestra plantilla de índice personalizada tendría que estar en  <code>/lib/templates/erb/scaffold/index.html.erb</code>.  Ahí podemos poner la plantilla por defecto para hacer uestros cambios.  Una vez que los hayamos hecho si creamos un nuevo andamiaje, por ejemplo para un modelo llamado <code>Category</code> veremos que la vista de índice ya incorpora nuestra propia plantilla.</p>

<pre class="terminal">
rails g scaffold category name:string
</pre>

<p class="codeFilePath">/app/views/categories/index.html.erb</p>
<pre class="ruby">
&lt;h1&gt;Listing categories&lt;/h1&gt;

&lt;table&gt;
  &lt;tr&gt;
    &lt;th&gt;Name&lt;/th&gt;
    &lt;th&gt;&lt;/th&gt;
    &lt;th&gt;&lt;/th&gt;
    &lt;th&gt;&lt;/th&gt;
  &lt;/tr&gt;

&lt;% @categories.each do |category| %&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;%= category.name %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &#x27;Show&#x27;, category %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &#x27;Edit&#x27;, edit_category_path(category) %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= link_to &#x27;Destroy&#x27;, category, :confirm =&gt; &#x27;Are you sure?&#x27;, :method =&gt; :delete %&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;
&lt;/table&gt;

&lt;p&gt;&lt;%= link_to &#x27;New Category&#x27;, new_category_path %&gt;&lt;/p&gt;
</pre>

<p>Y eso es todo por este episodio.   En Rails 3 se han introducido muchas mejoras en los generadores que los hacen mucho más fáciles de personalizar.</p>
